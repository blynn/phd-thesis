\chapter{Curve Selection}

Let $E$ be an elliptic curve defined over a finite field $K$.
Let $P \in E(K)$ be a point of prime order $r$. Let $G = \langle P \rangle$.

We intend to build cryptosystems that operate in $G$. Hence
we perform field arithemtic in $K$ during cryptographic operations,
while the security of the resulting systems partly depends on the size of $r$.
Recall the size of $K$ is roughly the size of $\#E(K)$,
thus we desire $r$ to be as close to $\#E(K)$ as possible. Ideally,
$r$ and $\#E(K)$ are the same size, both being say $l$-bit numbers,
meaning we have $l$-bit security
in $G$ and the running times depend on operations on $l$-bit numbers.

We focus on the case where $r$ and $\#E(K)$ take roughly the same number of
bits (that is, they differ by some small constant), but we note
that relaxing this condition
allows us to use a wider variety of pairings.

If $L$ is a field extension of $K$
that contains the $r$th roots of unity (so $r$ divides $|L| - 1$),
then the Tate pairing
on $G$ can be computed by performing operations in $L$.

On the other hand, let $E[r]$ denote the group of points of order $r$.
The Weil pairing is defined on $E[r]$. For some field extension
$L'$ of $K$, $E(L')$ contains $E[r]$, and the Weil pairing can be
computed by performing operations in $L'$.

In order for the Tate pairing to be efficiently computable,
operations must be efficient in $L$.
Similarly, for the Weil pairing to be efficiently
computable, operations must be efficient in $L'$.
Thus we seek fields $L$ or $L'$ that are small enough so that field
operations are still fast.

We will define the \emph{embedding degree} which can be thought of as measuring
how much larger $L$ or $L'$ is compared to the field $K$.

It turns out that such a field $L'$ will always contain the $n$th
roots of unity, thus we always have $L \subseteq L'$.
The converse is not true. It is possible for the subset inclusion to be strict,
or in other words, for a field $L$ to contain the $r$th roots of unity but
at the same time have part of $E[r]$ lying outside $E(L)$.

However, the converse is almost true:

\section {The Embedding Degree}

\begin{theorem} \cite{bk}
Let $E$ be an elliptic curve defined over $\mathbb{F}_q$.
Let $r$ be a prime dividing $N = \#(\mathbb{F}_q$) with
$r \nmid q-1$.
Then for any positive integer $k$,
$E(\mathbb{F}_{q^k})$ contains all $r^2$
points of order $r$ if and only if $r \mid q^k - 1$.
\end{theorem}

\begin{proof}
It is well-known that if $E(\mathbb{F}_{q^k})$ contains $E[r]$
then $r \mid q^k - 1$, even without assuming $r \mid N$ or
$r \nmid q-1$~\cite{bk}.

Conversely, suppose $k > 1$ and $r \mid q^k - 1$.
Let $\Phi$ denote the Frobenius map. Consider the subgroup $T$ of $E[r]$
consisting of all points of trace zero, that is
\[
T = \{ Q \in E[r] : \tr Q = Q + \Phi(Q) + ... + \Phi^{k-1}(Q) = O \}
\]
(The group $T$ may be explicitly constructed by using the map $P \mapsto
P - \Phi(P)$ on points of $E(\mathbb{F}_{q^k})$.)
Now we have $\Phi(T) = T$, and also $T$ is not contained
in $E(\mathbb{F}_q)$ by assumption.

Hence $T$ is an eigenspace of $\Phi$, but not the $1$-eigenspace. Since the
eigenvalues of $\Phi$ must be $1$ and $q$, we see that $T$ must be the
$q$-eigenspace of $\Phi$ and hence
\[
\Phi^k(Q) = q^k Q = Q
\]
since $r \mid q^k - 1$. Thus $T$, like $E(\mathbb{F}_q)$ is fixed under
$\Phi^k$, and since these groups are linearly independent they generate all
of $E[r]$, implying that all of $E[r]$ is fixed under $\Phi^k$. Hence
$E[r] \subset E(\mathbb{F}_{q^k})$.
\end{proof}

\begin{definition}
Let $E$ be an elliptic curve defined over $K = \mathbb{F}_q$.
Let $k$ be the smallest positive integer such that $\#E(\Fq) \mid q^k - 1$.
Then we say that the embedding degree of the curve $E$ is $k$.
\end{definition}

Let $P \in E(K)$ be a point of order $r$.
Let $G = \langle P \rangle$.
If $r$ is a proper factor $\#E(\Fq)$,
then it could be that for some $j < k$, although $\#E(\Fq)$ does not
divide $q^j - 1$, we have $r \mid q^j - 1$, that is,
$\mathbb{F}_{q^j}$ contains all the $r$th roots of unity and this
subfield of $\mathbb{F}_{q^k}$ suffices for
the Tate pairing computation on $G$.

However, in practice, when we do use such a group $G$,
$r$ is a large prime factor of $\#E(\Fq)$ and with overwhelming probability
$\mathbb{F}_{q^k}$ is the smallest field extension that allows the computation
of the pairing.

In other words, in general, for a cyclic subgroup $G \subset \#E(\Fq)$
the embedding degree $k$ of $E(\Fq)$
may not be the smallest positive integer such that $r \mid q^k - 1$ but
in practice, $r$ is a large prime factor of $\#E(\Fq)$ the probability that
$k$ is not the integer we seek is negligible.

If we insist on precision, we could revise our definition of the embedding
degree to take the cyclic subgroup $G$ into account, but for cryptographically
useful groups this subtlety may be ignored. Below, we shall make statements
about embedding degrees ignoring the negligible probability that the
real embedding degree could be smaller.

Thus in practice, we construct a curve $E(\Fq)$ with some embedding degree
$k$. Then $r$ is chosen to be a large prime factor of
$\#E(\Fq)$ so that $k$ is also the smallest integer such that $r \mid q^k - 1$
with overwhelming probability.

However, for very small toy examples, after computing the embedding degree
$k$ one should manually check if $r \mid q^j - 1$ for some $j < k$.

At this point, our goal seems to be minimizing this embedding degree,
so that $L$ is as close as possible to $K$, and if possible,
to have $K = L$ and have all computations in a
small a field as possible.

However, the pairing is a double-edged sword. Though it
bestows additional cryptographically useful properties upon cyclic groups,
we will show how it also allows one to break the discrete log problem in $E(K)$
by first breaking the discrete log problem in $L$.
Since the latter are finite fields, subexponential
algorithms such as index calculus are applicable, thus the size of $L$ and
$L'$ must be large enough to resist this (1024 bits at the very least).

This statement is true for every nonsingular elliptic curve, but in general
the embedding degree is so large that it is futile to attempt this attack
on a typical elliptic curve as $L$ and $L'$ are far too large for any
practical calculations.
However, for pairings, we actively seek curves with low embedding
degrees and must take this attack into account.

Thus we shall find that constructing a pairing is a delicate balancing act:
$K$ must be large enough
so that $E(K)$ can foil generic discrete log attacks
(e.g. Pollard rho, baby-step-giant-step TODO: reference earlier chapter?).
, while $L$ must be
large enough to resist finite field discrete log attacks. At the same time,
$K$ and $L$ should be as small as possible to minimize time and space
usage.

\section {Weil and Tate Pairing Comparison}

The above theorem shows that if the embedding degree $k$ is greater than 1,
then both the Tate pairing and the Weil pairing may be computed by
performing field arithmetic in $\mathbb{F}_{q^k}$.

On the other hand, if the embedding degree $k$ is 1, the Tate pairing may
be computable in $\mathbb{F}_q$, but the Weil pairing may not be.
Usually this is not significant because we shall see
$k > 1$ is preferred.
Nonetheless, we shall find the Tate pairing to be the best choice in
any case due to other benefits.

Consider the curve $E: Y^2 = X^3 + X + 6$ which has
18 points over $\mathbb{F}_{19}$, quoted from a publication by
Balasubramanian and Koblitz~\cite{bk}.
The point $R=(0,5)$ generates a cyclic group of order 18,
so the point $P = 6R = (12,13)$ generates a cyclic group of order 3.

We see $E[3]$ cannot be contained in $\langle R \rangle = E(\mathbb{F}_{19})$
since $E[3]$ is not cyclic, thus the Weil pairing cannot be computed.
(It turns out we must move to $\mathbb{F}_{19^3}$ to do so.)

In contrast, $3 \mid 19-1$ hence the Tate pairing can be
computed in $\mathbb{F}_{19}$. In fact, we find $e(P, R + 3G) = 11$, where
$e$ denotes the Tate pairing.
(Recall that pairings are only unique up to a constant, so different
implementations may give different results.
Sjnce the cube roots of unity in
$\mathbb{F}_{19}$ are $1, 7, 11$, we expect $7$ or $11$.)

We can also use this curve to exhibit
interesting behaviour that can occur with
pairings on cyclic groups with composite order.
It can be checked that $e(R, R) = 17$, a ninth root of unity.
(If were to strictly adhere to the definition of the Tate pairing
the second input should be written as $R + 18G$ since it is supposed to be
a coset, but this is superfluous since $18G$ is the trivial group.)
Thus we have a pairing that maps two groups of order 18
to a group that has order 9.
This implies, for example, $e(R, 9R) = 1$.

In contrast, if the order of $R$ were some prime $r$, nondegeneracy implies
that $e(P, Q)$ must also be of order $r$ for any
$P, Q \in \langle R \rangle \setminus \{ O \}$.
In fact, $e(P, Q) = 1$ would imply at least one of $P, Q$ is $O$ in this case.
Because most pairing-based cryptosystems use groups of prime order,
one may become so accustomed to facts like these that one may erroneously
assume them to be true when working with groups of composite order.

\section {Security Considerations}

Consider a nonsingular elliptic curve $E$ over finie field $\Fq$ with
embedding degree $k$.
We mentioned earlier that with pairings,
we can solve the discrete log problem in
$E(\Fq)$ by first solving the discrete log problem in $E(\Fqk)$.
We now give the details for this attack~\cite{mov,fr}.
This attack was the first application of pairings in cryptography
to appear in the literature, predating all publications describing
constructive uses of the pairing.

Let $P \in E(\Fq)$ be a point of prime order $r$.
Let $G = \langle P \rangle$.
By bilinearity and nondegeneracy of the Weil pairing
$e : G \times G \rightarrow \Fqk$ we have
\[ \dlog (P, nP) = \dlog ( e(P,P), e(P, nP) )
= \dlog (e(P,P),e(P,P)^n) = n \]
for $n \in \{0,...,r-1\}$.
Since $e(P,P), e(P, nP) \in \Fqk$,
if the discrete logarithm problem can be solved
in $\mathbb{F}_{q^k}$, then it can also be solved in $G$. The corresponding
attack for the Tate pairing is similar.

Hence we must ensure $q^k$ is large enough so that
finite field discrete logarithm algorithms such as index calculus are
infeasible in $\mathbb{F}_{q^k}$.

Are there any other attacks that concern us? It turns out
the curves used in pairing-based cryptography are special in other senses.
They are supersingular, or have complex multiplication.
Fortunately, no specific attacks for either case is known.

We have now described all necessary conditions on the sizes of
$r$ and $q^k$:

\begin{enumerate}
\item
$r$ must be a large enough prime so that generic discrete logarithm attacks
in a group of order $r$ are ineffective. Since $q \approx \#E(\mathbb{F}_q)$,
this places a similar lower bound on $q$.
\item
$q$ ought to be as small as possible, so that computations in $\mathbb{F}_q$
are as fast as possible.
\item
$q^k$ must be large enough so that finite field discrete logarithm attacks
in $\mathbb{F}_{q^k}$ are ineffective.
$q$ should not have low Hamming weight~\cite{someone}, nor be a power of
$2$ or $3$.
\item
$q^k$ must be small enough so that operations in $\mathbb{F}_{q^k}$
are efficient. All other things being equal,
$q^k$ should be small as possible so that operations
are as fast as possible.
\end{enumerate}

Of course, the first three statements are true for any cryptographically
useful elliptic curve, not just for pairing-based cryptography.

Currently it is acceptable to have $r$ about 160-bits.
As for $q^k$, 1024 bits is adequate for many applications, and calculations
in fields of this size can certainly be performed.
Ideally we have $r \approx \#E(\mathbb{F}_q) \approx q$
and hence $q$ is also about 160 bits. This gives an
embedding degree $k$ around $1024 / 160 = 6.4$.

We later describe how to construct curves of embedding degree 6 and 12.
For the near future, embedding degree 6 should be reasonable if used along
with an $r$ that is at least $170$ bits long,
and embedding degree 12 curves may be more desirable as time passes.

\section {Approaches to Finding Curves}

A randomly-chosen elliptic curve will have a large embedding
degree, which instills it with resistance to the aforementioned discrete log
attack, but also renders it useless for pairing-based cryptography.
We must take one of two approaches to find curves suitable for pairings:

\begin{enumerate}
\item
Supersingular curves are guaranteed to have a small embedding degree,
and are easy to construct. They have been completely classified. Operations
on some of them can be highly optimized.
\item
By carefully tailoring the complex multiplication method of constructing
elliptic curves, we can produce curves of a certain embedding degree. 
\end{enumerate}

We note that supersingular hyperelliptic curves have also been considered,
and it is thought that using the hyperelliptic equivalent of the
complex multiplication method may lead to more curves with low
embedding degrees, though further research in this area is required.

Below we survey some types of curves used in practice for pairing-based
cryptography. To make them easier to refer to, we label them with letters.
The labelling is arbitrary, though we try to arrange them in the order
they appeared in cryptography publications.

\section {Supersingular Curves}

There are six families of supersingular curves, with embedding degree at
most six \cite{mov}. Let $q=p^m$. Let $t$ denote the trace of Frobenius.
Then the six classes can be described as follows.

\begin{enumerate}
\item
$k = 2$: $ t = 0$ and $E(\mathbb{F}_q) \cong \mathbb{Z}_{q+1}$.
\item
$k = 2$: $ t = 0$ and $E(\mathbb{F}_q) \cong \mathbb{Z}_{(q+1)/2} \oplus \mathbb{Z}_2$ and $q = 3 \pmod{4}$.
\item
$k = 3$: $ t^2 = q$ and $m$ is even.
\item
$k = 4$: $ t^2 = 2q$ and $p = 2$ and $m$ is odd.
\item
$k = 6$: $ t^2 = 3q$ and $p = 3$ and $m$ is odd.
\item
$k = 1$: $ t^2 = 4q$ and $m$ is even.
\end{enumerate}

Some curves in the first two classes are easy to describe, and are
extremely useful, as it is easy to find curves containing a
subgroup of any desired order.

The $k=4$ case requires $p=2$.
Many specialized optimizations exist for
operations in characteristic two fields,
but unfortunately at the same time specialized discrete logarithm attacks
exist \cite{coppersmith}, and we must use bigger fields to compensate for
this. 

TODO:how bad is it?

The $k=6$ case requires $p=3$. Again, we may apply
a host of specialized optimizations, but we must also be wary of
low-characteristic discrete logarithm algorithms.

\section {Type A Curves}

Let $q$ be a prime satisfying $q = 3 \pmod{4}$.
Let $E$ be the curve $y^2 = x^3 + x$. It can be shown \cite{silverman86}
that $E(\mathbb{F}_q)$ is supersingular and $k = 2$.

We have $\#E(\mathbb{F}_q) = q+1$, and $\#E(\mathbb{F}_{q^2}) = (q+1)^2$,
thus for any $P\in E(\mathbb{F}_q)$
the embedding degree of $G = \langle P \rangle$ is 2.

Note $-1$ is a quadratic nonresidue in $\mathbb{F}_q$ since $q = 3\pmod{4}$.
Consider the map given by
\[ \Psi(x, y) = (-x, i y) \]

Then $\Psi$ maps points of $E(\mathbb{F}_q)$ to points of
$E(\mathbb{F}_{q^2}) \setminus E(\mathbb{F}_q)$. Thus if $f$ denotes the
Tate or Weil pairing, then defining $e:G \times G \rightarrow \mathbb{F}_{q^2}$
by

\[ e(P,Q) = f(P, \Psi(Q)) \]

gives a bilinear nondegenerate map.

Setup for this type of pairing for a cryptosystem can be done as follows.

\begin{enumerate}
\item
An order $r$ is chosen, large enough to avoid generic discrete logarithm
attacks. Other properties may be desired. For some cryptosystems $r$ is
an RSA modulus. As we will see, careful choices of $r$ will speed up Miller's
algorithm substantially.
\item
Recall we require finite field discrete logarithm attacks on $\mathbb{F}_{q^2}$
to be impractical. Thus a random multiple of four $h$ is generated,
where $h$ is large enough to guarantee $(hr)^2$ is big enough to resist
finite field attacks. For example, if $r$ is 160 bits long, and we want
$q^2$ about 1024 bits long, then $h$ must be about 352 bits long.
\item
Next it is checked that $q = h r - 1$ is prime.
If not, we go back to the previous step.
\item
For some cryptosystems problems may arise if $r \nmid h$, but this occurs
with negligible probability for realistic parameters. Nonetheless, when toy
examples are constructed, this may need to be checked.
\end{enumerate}

If $h$ is constrained to be a multiple of $3$ as well, then cube roots are
extremely easy to compute in $\mathbb{F}_{q}$:
for all $x \in \mathbb{F}_q$ we see $x^{-(q-2)/3}$ is the cube root of $x$
(cube roots are necessarily unique since each element is a cube).
This may be desirable in some situations, and hardly affects the setup
algorithm.

\section {Type B Curves}

Let $q$ be a prime satisfying $q = 3 \pmod{4}$.
Let $E$ be the curve $y^2 = x^3 + 1$. Then
$E(\mathbb{F}_q)$ is supersingular and $k = 2$.

Again we have $\#E(\mathbb{F}_q) = q+1$ and $\#E(\mathbb{F}_{q^2}) = (q+1)^2$,
thus for any $P\in E(\mathbb{F}_q)$
the embedding degree of $G = \langle P \rangle$ is 2.

Consider the map given by
\[ \Psi(x, y) = (\zeta x, y) \]
where $\zeta$ is a primitive cube root of unity.

Then $\Psi$ maps points of $E(\mathbb{F}_q)$ to points of
$E(\mathbb{F}_{q^2}) \setminus E(\mathbb{F}_q)$. Thus if $f$ denotes the
Tate or Weil pairing, then defining $e:G \times G \rightarrow \mathbb{F}_{q^2}$
by

\[ e(P,Q) = f(P, \Psi(Q)) \]

gives a bilinear nondegenerate map.

We shall see cube roots are easy to find since $q = 2 \pmod{3}$.
For this particular curve, this means we may quickly generate points from
a $y$-coordinate, yielding simple and efficient random point generation and
hashing-to-point routines.
Additionally,
points can be represented by their $y$-coordinate alone since there is
a unique $x$ for each value of $y$.

They do have one drawback however. Unlike the previous type,
there is a certain optimization that
only applies if we forgo symmetry of the pairing. One must choose between
symmetry and efficiency in this case.

\section {Type C Curves}

Define the curves $E^{+} : y^2 = x^3 + 2 x + 1$ over $\F_{3^l}$
and $E^{-} : y^2 = x^3 + 2 x - 1$, also over $\F_{3^l}$.

Unlike all the other curves we consider,
we are working in a low characteristic field, and furthermore this
field does not have prime order.

It turns out
\[
\#E^+(\F_{3^l}) = \left \{ \begin{array}{rcl}
3^l + 1 + 3^{(l+1)/2} \mbox { when } l = \pm 1 \bmod 12 \\
3^l + 1 - 3^{(l+1)/2} \mbox { when } l = \pm 5 \bmod 12
\end{array} \right.
\]
and $\#E^-(\F_{3^l}) + \#E^+(\F_{3^l}) = 2(3^l + 1)$, that is
\[
\#E^-(\F_{3^l}) = \left \{ \begin{array}{rcl}
3^l + 1 - 3^{(l+1)/2} \mbox { when } l = \pm 1 \bmod 12 \\
3^l + 1 + 3^{(l+1)/2} \mbox { when } l = \pm 5 \bmod 12
\end{array} \right.
\]
and it is easily checked that both types of curve have embedding
degree 6 (that is, the order divide $3^{6l} -1$ in all cases).

For an $l = \pm 1, \pm 5$ and a
curve $E : y^2 = x^3 + 2 x \pm 1$ over $\mathbb{F}_{3^l}$
let $t$ be a root of $t^3 + 2t \pm 2 = 0$, and let $i$ be a
square root of $-1$. These both exist in $\mathbb{F}_{3^{6l}}$.
Define the map $\Psi$ by
\[ \Psi(x,y) = (-x + t, i y) \]
where $x, y$ are elements of $\F_{3^{6l}}$. Then $\Psi$ maps points
of $E(\F_{3^l})$ to points of $E(\F_{3^{6l}})$.

We arrive at a curve selection algorithm:

\begin{enumerate}
\item
Choose $l = \pm 1, \pm 5 \bmod 12$. To avoid Weil descent attacks,
$l$ should not have any small prime factors (say $3,5,7$).
\item
Compute $3^l + l \pm 3^{(l+1)/2}$ and check if either has a large prime
factor $r$.
\item
If so, set $E$ to the corresponding curve equation.
\end{enumerate}

It turns out there are not many suitable curves.

TODO: give table, mention coppersmith, cite weil descent paper

\section {Complex Multiplication}

Suppose we have integers $D, V, q, t$ satisfying the \emph{CM equation}
\[ D V^2 = 4 q - t^2 \]
such that $D = 0, 3 \bmod 4$ is positive and $q$ is prime.

View the Hilbert polynomial $H_D(x)$ as a polynomial in $\F_q[x]$,
and let $j \in \F_q$ be any root. For $j \ne 0, 1728$, set
$k = j / (1728 - j)$. Then the curve
\[ E: y^2 = x^3 + 3 k c^2 x + 2 k c^3 \]
has $j$-invariant $j$ for any nonzero $c \in \F_q$.

Set $c = 1$. Then $E$ has order $q + t + 1$ or $q - t + 1$.
Generate a random point $P$ of $E$ and check if
$(q-t+1)P = O$. If not, then the order must be $q + t + 1$,
and if we set $c$ to be some quadratic nonresidue in $\F_q$ the
curve will have order $q - t + 1$.

For $j = 0$ the curve has the form $y^2 = x^3 + k$ for some $k$.
For $j = 1728$ the curve has the form $y^2 = x^3 + k x$ for some $k$.
In these cases one can try different values of $k$ until a curve
with the correct order is found.

Thus given a solution the above equation, we may easily write down
a curve of order $q+t-1$ or $q-t-1$.

\section {Type D Curves}

Miyaji et al. describe a method for constructing ordinary elliptic
curves with embedding degree 3,4 or 6 \cite{mnt}. Moreover, they show
that in a sense, there are no other parametrizations that lead to curves
with these embedding degrees.

We first examine the embedding degree six case, which is the most useful.
The embedding degree three and four cases may also be useful in special
circumstances and we briefly describe them.

Consider the polynomials $q = x^2 + 1, t = \pm x + 1$.
It turns out that $q(x) + 1 - t(x) \mid q(x)^6 - 1$.

The CM equation becomes $D V^2 = 3 x^2 \pm 2 x + 3$. If we make
the substitution $U = 3x \pm 1$ then we have the generalized Pell equation
\[
U^2 - 3DV^2 = -8
\]

Thus:

\begin{enumerate}
\item
Choose $D$ and solve the Pell-type equation
\[ U^2 - 3DV^2 = -8 \]
\item
We have $U = \pm 1 \pmod 3$. Set $x = (-1 \pm U) / 3$
\item
Check that $q = x^2 + 1$ is prime
\item
Recall $t = \pm x + 1$.
Check that $q - t + 1 = q \mp x$ has a large prime factor $r$.
(Ideally it should be prime.)
\item
Check that $r$ does not divide $q^j = 1$ for any positive integer $j < k$.
(This can be omitted in practice as it is extremely unlikely this will
occur.)
\item
Use the CM method to construct a curve $E$ with order $q \mp x$.
\end{enumerate}

The resulting curve $E$ will have embedding degree 6.

We explain this method via the cyclotomic polynomials $\Phi_k(x)$.
Suppose $t = x + 1$.
Recall $\Phi_6(x) = x^2 - x + 1$, thus
$q = x + \Phi_6(x)$.
Then the order $n$ of the resulting
curve $E$ is $n = \Phi_6(x)$, thus
\[ q^6 - 1 = x^6 - 1 \bmod n \]

Recall $\Phi_6(x) \mid x^6 - 1$, hence $n$ must also divide $q^6 - 1$
giving an embedding degree of 6.

Now suppose $t = -x + 1$.
Recall $\Phi_3(x) = x^2 + x + 1$, thus
$q = -x + \Phi_3(x)$.
The order $n$ of $E$ is $n = \Phi_3(x)$, hence
\[ q^6 - 1 = (-x)^6 - 1 = x^6 - 1 \bmod n \]
Since $\Phi_3(x) \mid x^6 - 1$ the embedding degree of $E$ is 6.
Of course $\Phi_3(x) \mid x^3 - 1$ but $x^3 \ne (-x)^3$ in general
thus the embedding degree is not 3 (with high probability).

For an embedding degree of 4, we may also use cyclotomic polynomials.
Recall $\Phi_4(x) = x^2 + 1$. Then set $q = \pm x + \Phi_4(x)$
so that $t = \pm x + 1$. Since $n = \Phi_4(x)$ we have
\[ q^4 - x = (\pm x)^4 - 1 \bmod n \]
thus $n \mid q^4 - 1$.
(When the minus sign is chosen and $x$ replaced by $x+1$ 
we match the notation of Miyaji et al.\cite{mnt}.)

For $k=3$ Miyaji et al. give $q = 3 x^2 - 1$, $t = -1 \pm 3x$ where $x$ is
even.

\section {Type E Curves}

Curves of embedding degree 1 are easily constructed using the CM method.
Let $t = 2$, $D = 7$. Let $r$ be a positive integer
and suppose $q = 28 r^2 h^2 + 1$ is prime for some $h$.
Then the CM equation
\[
7 V^2 = 4 (28 (r h)^2 + 1) - 4
\]
is satisfied when we take $V = 4 r h$.

As $H_7(x) = x + 3375$, if we take $k = -3375 / (1728 - 3375)$ in $\F_q$
then the curve
\[
y^2 = x^3 + 3k x + 2k
\]
has order $q - 1$ or $q + 3$. Taking the twist if necessary,
find the curve with order $q-1$.

Note $r \mid q-1$ hence the Tate pairing on this curve can be computed
in $\F_q$. For most applications we choose $r$ to be prime but composite
orders can be chosen instead.

\section {Type F Curves}

By considering cyclotomic polynomials,
Barreto and Naehrig discovered a parametrization yielding embedding
degree 12 curves.

Let $q(x) = 36x^4 + 36x^3 + 24x^2 + 6x + 1$. Let $t(x) = 6x^2 + 1$.
Then if $D = 3$, the CM equation always has the solution
$V = 6x^2 + 4x + 1$. Furthermore,
it turns out $q(x) + 1 - t(x) \mid q(x)^{12} - 1$.
This suggests the following algorithm to generate curves:

\begin{enumerate}
\item
Pick an integer $x$ of a desired magnitude. It may be negative.
\item
Check if $q(x)$ is prime.
\item
Check if $n = q(x) - t(x) + 1$ has a large prime factor $r$.
(Ideally it should be prime.)
\item
Try different values of $k$ until a random point of
$y^2 = x^3 + k$ has order $n$
\end{enumerate}

Barreto and Naehrig recommend the last step be done as follows:
starting from $k = 1$, keep incrementing $k$ until $k+1$ is a quadratic
residue and $n(1,g) = O$, where $g$ is a square root of $k + 1$.

\section {Type G Curves}

The ideas of Miyaji et al. have been developed extensively\cite{alotofstuff}.
For example, methods exist to construct curves of any embedding degree
provided that one can tolerate a subgroup order $r$ that is
in general significantly smaller than the field order $q$.

Freeman unified many of the approaches in a single
framework\cite{freeman06}, and also showed how to construct curves with
embedding degree 10, with $r$ and $q$ around the same size.
Freeman also notes that it seems unlikely that curves
with embedding degrees other than the ones described in this chapter
can be constructed using these techniques.

We summarize an algorithm due to Freeman and Scott:

Set $q(x) = 25x^4 + 25x^3 + 25x^2 + 10x + 3$ and
$t(x) = 10x^2 + 5x + 3$.

\begin{enumerate}
\item
Choose $D$ such that $D$ is squarefree and $D = 43, 67 \bmod 120$.
\item
Find solutions $(u,v)$ to the equation $u^2 - 15 Dv^2 = -20$.
\item
We have $u = \pm 5 \bmod 15$.
Set $x = (-5 \pm u)/15$.
\item
Check $q(x)$ is prime.
\item
Check $n = q(x) - t(x) + 1$ has a large prime factor $r$.
\item
Construct the corresponding curve $E$ using the CM method.
\end{enumerate}
%Multiply $u+v\sqrt{15 D}$ by a norm-one element of $\mathbb{Q}(\sqrt{15D})$
%and get next candidate

It can be shown that $n \mid q^{10} - 1$ thus the resulting curve has
embedding degree 10.

TODO: comparison table: symmetric? group sizes? embedding degree? ordinary?

\section {Generalized Pell Equations}

Consider the \emph{Pell equation}
\[ x^2 - D y^2 = 1 \]
where $D$ is not a square, $x, y$ are integers.
We solve such an equation using the
continued fraction expansion of $\sqrt{D}$:
\[
\begin{array}{rcl}
P_0 &=& 0 \\
Q_0 &=& 1 \\
a_0 &=& \left\lfloor{\sqrt{D}}\right\rfloor \\
P_1 &=& a_0 \\
Q_1 &=& D-a_0^2 \\
a_n &=& \left\lfloor { \frac {a_0 + P_n}{Q_n} } \right\rfloor \\
P_n &=& a_{n-1} Q_{n-1} - P_{n-1} \\
Q_n &=& \frac{D - P_n^2}{Q_{n-1}}
\end{array}
\]

One can show for some $k$ we must have $a_{k+1} = 2 a_0$, and after
this point the $a_n$ sequence begins repeating. That is
$\sqrt{D} = [a_0, a_1, ..., a_{k+1}, a_1, ..., a_{k+1}, ... ]$.

The convergents are given by
\[ p_0 = a_0, p_1 = a_0 a_1 + 1, p_n = a_n p_{n-1} + p_{n-2} \]
and
\[ q_0 = 1, q_1 = a_1, q_n = a_n q_{n-1} + q_{n-2} .\]
These satisfy
\[ p_n^2 - D q_n^2 = (-1)^{n+1} Q_{n+1} . \]

It turns out that $(x, y) = (p_k, q_k)$ is the smallest positive
integer equation
of the Pell equation for odd $k$, and $(x, y) = (p_{2k+1}, q_{2k+1}$ is for
even $k$. Denote this minimal positive solution by $(t, u)$.
Then all positive solutions $(x, y)$ to the Pell equation can be found via
\[ x + y\sqrt{D} = (t+u\sqrt{D})^n\]
(for all positive integers $n$). The negative solutions (which we
never need) in this case are trivial to find from the positive solutions.

\subsection {Generalized Pell Equations}

Now suppose we are to solve the \emph{generalized Pell equation}
\[ x^2 - D y^2 = N \]
where $D$ is not a square, $x, y$ are integers.

When $N^2 < D$ we first solve the Pell equation
\[ x^2 - D y^2 = 1 \]
using the above method, that is, computing convergents $p_n, q_n$
until the minimal positive solution is found. However,
while doing so, we check if $p_n^2 - D q_n^2 = N / f^2$ for
some positive integer $f$. If so, then we append $(f p_n, f q_n)$ to
the list of solutions of the generalized Pell equation.

If no such convergents are found by the time we have reached the minimal
positive solution for the Pell equation, then the generalized Pell
equation has no solution.

Otherwise let $(t, u)$ be the minimal positive solution of the above
Pell equation.
Then for each $(r,s)$ on the list of solutions we have a family of
solutions $(x,y)$ given by
\[ (x+y\sqrt{D}) = (r+s\sqrt{D})(t+u\sqrt{D})^n \]
(for all positive integers $n$). These families account for all positive
integer solutions to the generalized Pell equation.

When $N^2 \ge D$ there are possibly other fundamental solutions
to the generalized Pell equation we must add to the list before generating
families of solutions.
We can use brute force to find them if the numbers are small enough.

For positive $N$ set $L_1=0, L_2 =\sqrt{N(t-1)/2D}$. For negative $N$
set $L_1 = \sqrt{-N/D}, L_2=\sqrt{-N(t+1)/2D)}$. For all integers $y$
satisfying $L_1\le y \le L_2$ check if there exists any integer $x$ such that
$x^2 - Dy^2 = N$.
Append any solutions $(x,y)$ to our list. Also append $(x,-y)$ if
it does not appear in the family of solutions generated by $(x, y)$.

\section {Hilbert Polynomials}

We quote an algorithm to compute Hilbert class
polynomials as described by Cohen~\cite[section 7.6.2]{1993-cohen}.

Let $\tau \in \mathbb{C}$ lie in the upper complex plane.
Set $q = e^{2 i \pi \tau}$. Define
\[
\Delta(\tau) = q\left(1+\sum_{n\ge1}(-1)^n
\left({q^{n(3n-2)/2} + q^{n(3n+1)/2}}\right)\right)^{24}
\]
and
\[
f(\tau) = \frac{\Delta(2\tau)}{\Delta(\tau)}
\]
and finally
\[
j(\tau) = \frac{(256 f(\tau) + 1)^3}{f(\tau)}
\]
Then the Hilbert class polynomial for the discriminant $-D$ is
given by
\[ H_D(x) = \prod (X - j(\alpha) \]
where $\alpha$ runs over all complex numbers such that
\[ \alpha = \frac{-b+\sqrt{-D}}{2a} \]
where $ax^2 + bxy + cy^2$ is a \emph{primitive reduced positive definite
binary quadratic form} of discriminant $-D$, or in other words,
$b^2 - 4ac = -D$, $|b| \le a \le \sqrt{|D|/3}$, $\gcd(a,b,c)=1$ and
if $|b| = a$ or $a=c$ then $b\ge0$.

Hence the following algorithm computes Hilbert class polynomials.
Here, $P$ is a polynomial variable, and $D = 0, -1 \pmod 4$.

\begin{algorithmic}[1]
\STATE $P\gets 1$
\STATE $b\gets D \pmod 2$
\STATE $B\gets \left\lfloor\sqrt{|D|/3}\right\rfloor$
\REPEAT
    \STATE $b\gets b+2$
    \STATE $t\gets (b^2+D)/4$
    \STATE $a\gets \max(b,1)$
    \REPEAT
	\IF {$a^2 \mid t$}
	    \STATE $u\gets j((-b+\sqrt{D})/(2a))$
	    \IF {$a = b$ or $a^2 = t$ or $b=0$}
		\STATE $P \gets P(X-u)$
	    \ELSE
		\STATE $P \gets P(X^2 - 2\Re(u)X+|u|^2)$
	    \ENDIF
	\ENDIF
	\STATE $a=a+1$
    \UNTIL $a^2>t$
    \STATE $b=b+2$
\UNTIL $b>B$
\STATE round coeffcients of $P$ to nearest integer
\STATE return $P$

\end{algorithmic}

It remains to specify the precision of the floating point operations.
Cohen recommends using at least $k + 10$ significant digits where
\[ k = \pi \frac{\sqrt{|D|}} {\ln 10} \sum \frac{1}{a} \]
the sum running over all reduced forms $(a,b,c)$ of discriminant $D$,
which can be computed using the following algorithm~\cite[Algorithm 5.3.5]{1993-cohen}:

\begin{algorithmic}[1]
\STATE $s\gets 1$, $b\gets D \pmod 2$, $B\gets \left\lfloor \sqrt{|D|/3}
\right\rfloor$.
\REPEAT
    \REPEAT
	\STATE $q\gets (b^2 - D)/4$, $a\gets b$
	\IF {$a\le 1$}
	    \STATE $a\gets 1$
	\ELSIF {$a\mid q$}
	    \IF {$a=b$ or $a^2=q$ or $b=0$}
		\STATE $s=s+1/a$
	    \ELSE
		\STATE $s=s+2/a$
	    \ENDIF
	\ENDIF
	\STATE $a\gets a+1$
    \UNTIL $a^2>q$
    \STATE $b\gets b+2$
\UNTIL $b>B$
\STATE Output $s$
\end{algorithmic}
