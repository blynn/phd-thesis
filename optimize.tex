\chapter{Optimizing the Pairing}

TODO: move to a good spot
\section {Twisting Curves}

Let $E$ be an elliptic curve $Y^2 = X^3 + a X + b$ in $\Fq$ where
$q$ is a prime power.
Let $v$ be a quadratic nonresidue in $\Fq$.
Consider
the curve $E'$ given by $Y^2 = X^3 + a v^2 X + v^3 b$,
which we call the (quadratic) \emph{twist} of the curve $E$.

\begin{theorem}
Let $t = q + 1 - \#E(\Fq)$. Then $\#E'(\Fq) = q + 1 + t$.
\end{theorem}

The proof is straightforward.
Let $g(X) = X^3 + a X + b$, and $h(X) = X^3 + a v^2 X + v^3 b$.
Note $h(X) = v^3 g(Xv^{-1})$.

There are three cases.

\begin{enumerate}
\item
If $g(xv^{-1}) = 0$ then $v^3g(xv^{-1}) = h(x) = 0$ thus
$Y = 0$ is the unique solution to both the
equations $Y^2 = g(xv^{-1})$ and $Y^2 = h(x)$.
\item
If $g(xv^{-1})$ is a quadratic residue then $Y^2 = g(xv^{-1})$
has exactly two solutions,
and $Y^2 = v^3 g(xv^{-1}) = h(x)$ has no solutions (since $v^3$
is a quadratic nonresidue).
\item
If $g(xv^{-1})$ is a quadratic nonresidue then the situation is reversed:
$Y^2 = g(xv^{-1})$ has no solutions and
and $Y^2 = h(x)$ has exactly two solutions.
\end{enumerate}

As $x$ runs through all the elements of $\Fq$, so does $xv^{-1}$,
and we see that total number of solutions to either equation $E$ and $E'$
over $\Fq$ is $2q$.
Since $O$ is always a solution of any elliptic curve we have
$\#E(\Fq) + \#E(\Fq) = 2q + 2$, proving the theorem.

On the other hand if $v$ is a quadratic residue then $v = c^2$ for some
$c \in \Fq$. Then we have a map $\Psi : E'(\Fq) \rightarrow E(\Fq)$
given by

\[ \Psi(x,y) = (c^2 x,c^3 y) \]

hence in some sense $E$ and $E'$ are the same curve, so the choice of
quadratic nonresidue $v$ does not matter as they all lead to the same twist.

Note a quadratic
nonresidue $v$ becomes a quadratic residue in $\F_{q^2}$ (that is, we
can find a square root $c$ of $v$)
and we have a map between
$E'(\F_{q^2})$ and $E(\F_{q^2})$. Roughly speaking, curves that are twists
of each other become the same curve when considered in a quadratic extension
of the field they are defined in.

For example, since $2$ is a quadratic nonresidue in $\F_{19}$,
the curve $E : Y^2 = X^3 + X + 6$ (over $\F_{19}$) has the
twist $E': Y^2 = X^3 + 4 X + 10$, and $E'(\F_{19})$ contains 22 points.

In $\F_{19^2}$, both $E$ and $E'$ contain 396 points, and we can map
points of $E'$ to points of $E$ via $(x,y) \rightarrow (2 x, 2\sqrt{2} y)$.

We can use quadratic residues to transform the equation of a given elliptic
curve $E$ into a form that allows certain optimizations.
It turns out that ideally we would like $a = 0$ to reduce the amount of
operations needed to compute on an elliptic curve, but for a general curve
this an impossible transformation. We shall see a reasonable alternative
is $a = -3$.

Then from above, a curve $Y^2 = X^3 + aX + b$ can be transformed into
one of the form $Y^2 = X^3 - 3X + b'$ if we can find $c\in \Fq$
satisfying $a c^4 = -3$.

This is not always possible, so a compromise is to have
$a = 1$ or $a = -3 d^2$ for some small integer $d$
(or $d$ of low Hamming weight), which can be achieved in a similar manner.


TODO: Miller:
For faster pairings, it is desirable to choose $r$ so that repeated squaring
algorithms can be optimized: e.g. choose $r$ to have a low Hamming weight,
or to be a Solinas number (i.e. $r$ has the form $2^a \pm 2^b \pm 1$).

We find when the embedding degree is greater than $1$ we may simplify
the Tate pairing as follows \cite{barreto, barreto2}.
\begin{theorem}
Let $E$ be an elliptic curve over $\F_q$.
Let $P \in E(\F_q)$ be a point of prime order $r$.
Let $G = \langle P \rangle$, and let $k$ be the embedding degree of $G$.

If $k > 1$ then
\[
e(P,Q) = f_P(Q)^{(q^k-1)/r}
\]
is a bilinear nondegenerate map,
where $f_P$ is a function with divisor $r\langle P\rangle - r\langle O\rangle$.
\end{theorem}

\begin{proof}
Choose any point $R \in E(\F_q)$ that is not one of
$O, -P, Q, -Q, Q - P$,
and consider the function $f'_P$ that satisfies $(f'_P) = r\langle P+R\rangle
- r\langle R \rangle$.
The Tate pairing can be computed by
\[
(f'_P(Q)/f'_P(O))^{(q^k-1)/r}
\]
We have $f'(O) \in \F_q^*$ since it does not have a zero or pole
at $O$. Hence
$f'(O)^{(q^k-1)/r} = 1$ by Fermat's Little Theorem (we know $q-1$ must
divide $(q^k - 1)/r$ since $r\nmid q-1$) thus
\[ e(P,Q) = f'_P(Q)^{(q^k-1)/r} . \]
Let $V_R(X,Y)$ be the equation of a vertical line through $R$,
let $V_P(X,Y)$ be the equation of a vertical line through $P$,
and let $L(X,Y)$ be the equation of a line through $P+R$ and $-R$ (and hence
$-P$).
Then we have
\[ (f'_P V_R^r V_P^r / L^r) = r \langle P \rangle - r \langle O \rangle
= (f_P) \]
None of $V_R, V_P, L$ have zeroes or poles at $Q$ by choice of $R$.
Since each of $V_R(Q), V_P(Q), L(Q)$ is ultimately exponentiated by $q^k-1$
we have $f'_P(Q) = f_P(Q)$.
(Alternatively we could appeal to Fermat's Little Theorem
again, since the lines can be chosen to have coefficients in $\F_q$.)
Hence
\[e(P,Q) = f_P(Q)^{(q^k-1)/r} . \]
\end{proof}

TODO:
(The proof of the above theorem is unclear in \cite{barreto}.
It can be salvaged: $f(X) + Y g(x) / u(X) + Y v(X)$, must have $g = v = 0$
since rational function agrees at $R, -R$. Then we have $f(x) / u(X)$
which splits in some extension of $K$ and
has divisor of the form $(\prod (P_i)(-P_i) / (Q_i)(-Q_i)$ which can
never be $(P)^n$.

\section {Twist Curves and the Trace-Zero Group}

Let $E : y^2 = x^3 + a x + b$ be an elliptic curve over $\F_q$,
and $P$ be a point of prime order $r$.
Suppose the embedding degree $k$ of $G = \langle P \rangle$ is even.

Let $d = k / 2$. Let $v$ be a quadratic nonresidue in $\F_{q^d}$,
so that $\F_{q^k} = \F_{q^d}[\sqrt{v}]$.
Let $E'$ be the twist of $E$ hence
$E' : y^2 = x^3 + v^2 a x + v^3 b$.

Define the map $\Psi:E'\rightarrow E(\F_q^k)$ by
\[ \Psi(x,y) = (v^{-1}x, v^{-3/2}y) . \]

\begin{theorem}
Let $E : y^2 = x^3 + a x + b$ be an elliptic curve over $\Fq$,
and $P$ be a point of prime order $r$.
Suppose the embedding degree $k$ of $G = \langle P \rangle$ is even.
Write $d = 2k$. Let $E'$ be the twist of $E$ in $\Fqd$.

Then $r \mid \#E'(\Fqd)$.
\end{theorem}

\begin{proof}
If $\#E(\F_{q^d}) = q^d + 1 - c$ then
\[ \#E'(\F_{q^d}) = q^d + 1 + c \]
and
\[ \#E(\F_{q^k}) = (q^{d} + 1 + c)(q^{d} + 1 - c) . \]
The group $E(\F_{q^d})$ only contains $r$ points of $E[r]$ otherwise
the embedding degree would be at most $d$, and similarly
$E(\Fqk)$ contains all $r^2$ points of $E[r]$,
hence
\[ r \mid q^{d} + 1 + c = \#E(\Fqd) .\]
\end{proof}

Let $P$ be any point of order $r$ in $E(\Fq)$ and
$Q'$ be any point whose order is a multiple of $r$ in $E'(\F_{q^d})$.
In practice a randomly chosen point of $E'(\F_{q^d})$ will do.

Let $G = \langle P \rangle, H = \langle Q' + r E'(\Fqd) \rangle$.
Note $H$ is a subgroup of $E'(\Fqd) / rE'(\Fqd)$.

Let $f$ be the Tate pairing.
Then $e$ definied by
\[e(P,Q') = f(P, \Psi(Q')) \]
is a bilinear map.
We may subsitute the Weil pairing if additionally
$r Q' = O$.

In practical terms, this means most operations are performed in
$\F_{q^d}$  or $\F_q$. The $\Psi$ map and
other computations in $\Fqk$ are only performed
when a pairing is being evaluated.

We may view this trick as a
generalization of the $\Psi$ map used in Type A curves.
(We have $k =2 , d = 1$.
The curve $E : y^2 = x^3 + x$ is equivalent to $E' : y^2 = x^3 + v^2 x$
because either $v$ or $-v$ is a quadratic residue.)

A dilemma arise with Type B curves however. The twist
of a curve $E : y^2 = x^3 + 1 $ is $E: y^2 = x^3 + v^3 $ for some
quadratic nonresidue $v$. We could work on these two curves but now
the pairing is no longer symmetric. On the other hand, if we insist on
a symmetric pairing, then although most computations can still be done
in $\Fq$, we cannot employ the optimization of the next section. For
many applications symmetry is not important, and efficiency is more important.

We can say more about this particular group selection.

\begin{theorem}
Let $E : y^2 = x^3 + a x + b$ be an elliptic curve over $\F_q$,
and $P$ be a point of prime order $r$.
Suppose the embedding degree $k$ of $G = \langle P \rangle$ is even.
Then write $d = k / 2$. Let $v$ be a quadratic nonresidue in $\F_{q^d}$,
Let $E'$ be given by $y^2 = x^3 + v^2 a x + v^3 b$.
Define the map $\Psi:E'\rightarrow E(\F_q^k)$ by
\[ \Psi(x,y) = (v^{-1}x, v^{-3/2}y) . \]

Then $\Psi(E'(\F_{q^d})[r])$ is precisely the subgroup of trace zero points
in $E(\Fqk)[r]$.
\end{theorem}

\begin{proof}
Given $Q' = (X,Y) \in E'(\F_{q^d})$ we have $\Psi(Q') = (a, b)$
where $a \in \F_{q^d}$, and $b$ has the form $b = c \sqrt{v}$ for some
$c \in \F_{q^d}$.

Now $\Phi_d(\sqrt{v}) = -\sqrt{v}$ (by direct verification and using
$v^{(q^d - 1)/2} = -1$ since $v$ is a quadratic nonresidue, or
from Galois theory: $\sqrt{v}$ must
be mapped to some other root of its minimal polynomial as $\Phi_d$ fixes
$\F_{q^d}$ but not $\F_{q^k}$).
Thus $\Phi^d(a) = a$ and $\Phi^d(b) = -b$, whence

\[ \Phi^d(\Psi(Q')) = \Phi^d(a,b) = (a, -b) = -\Psi(Q') \]

But it can be easily checked that
any point $Q \in E(\Fqk)$ satisfying $\Phi^d(Q) = -Q$ also satisfies
$\tr Q = O$, hence $\Psi(Q')$ is a point of trace zero.

Conversely, suppose $Q$ is a point of trace zero in $E(\Fqk)[r]$.
We have previously seen this implies $\Phi(Q) = q Q$,
thus $\Phi^d(Q) = q^d Q$.

Since $q^k = 1 \bmod r$, we have $q^d = -1 \bmod r$ (we cannot
have $q^d = 1 \bmod r$ since $k > d$ is the embedding degree).
Hence $\Phi^d(Q) = -Q$.

If we write $Q=(a,b)$ then this implies $a \in \F_{q^d}$ and $b = c \sqrt{v}$
for some $c \in \F_{q^d}$, thus $\Psi^{-1}(Q)$ lies on $E'(\F_{q^d})$.

Alternatively we may employ a counting argument to show the converse,
as there are exactly
$r$ points in $E'(\F_{q^d})[r]$ and exactly $r$ points in $E(\Fqk)[r]$ of trace
zero.)
\end{proof}

One consequence of this is that the asymmetric bilinear pairing defintion
cannot be used. Recall this requires an efficiently
computable bilinear nondegenerate map
\[
e:G_1 \times G_2 \rightarrow G_T
\]
along with an efficiently computable group isomorphism
$\phi : G_2 \rightarrow G_1$.

For a randomly chosen $Q$ in $E(\Fqk)[r]$ we have $\tr Q \ne O$ with
overwhelming probability, and one can take $\phi$ to be the trace map
as an efficiently computable isomorphism between $\langle Q \rangle$
and $E(\Fq)[r]$.

However, as we are picking $Q$ to be a point of trace zero, this choice
of $\phi$ no longer applies, thus we must use the more general definition
of a bilinear pairing.

TODO: Mike's even degree polynomial recommendation?

\section {Denominator Elimination}

We use the same notation and assumptions as the previous section.
In other words, again let $E : y^2 = x^3 + a x + b$ be an elliptic curve
over $\F_q$,
and $P$ be a point of prime order $r$.
Suppose the embedding degree $k$ of $G = \langle P \rangle$ is even
and write $k = 2d$.

Suppose we want to find $f_P(Q)$.
In Miller's algorithm, to calculate the denominator of
$f_P(Q)$, we evaluate the equation of various vertical lines
at a point. In other words, we compute $x - a$ where $a$ is the
$x$-coordinate of the line and $x$ is the $x$-coordinate of $Q$.

In the computation of the Tate pairing, we also exponentiate by
$(q^k - 1)/r$ to standardize the coset representative. Observe
$q^d - 1$ divides $(q^k-1)/r$ because if $r$ divides $q^d - 1$ then
the embedding degree is at most $d$, not $k$.

Thus if both $x$ and $a$ lie in $\F_{q^d}$ then we have
$(x-a)^{q^d - 1} = 1$ so they can be omitted during Miller's algorithm.
This occurs when twist curves are used, hence we may simplify
the computation of $f_P(Q)$ as follows.

\begin{enumerate}
\item
Set $f \leftarrow 1$, and $Z \leftarrow P$.
Let the binary representation of $r$ be $b_t ... b_0$.
\item
For $i \leftarrow t-1$ to $0$
    \begin{enumerate}
    \item
    Set $f \leftarrow f^2 T_Z(Q)$ and $Z \leftarrow 2Z$
    \item
    If $b_i = 1$ then
	\begin{enumerate}
	\item
	Set $f \leftarrow f L_Z(Q)$ and $Z \leftarrow Z + P$.
	\end{enumerate}
    \end{enumerate}
\end{enumerate}

If $r$ is odd, the if condition is true during the last iteration and
the last multiplication is
\[ f \leftarrow f L_{(r-1)P}(Q) .\]
Since $(r-1)P = -P$, this is equivalent to $f \leftarrow f V_P(Q)$
and hence can be skipped since no vertical line computations are needed.
In this case we have $f_r = f_{r-1}$ and the logic can be simplified.

\section {The Tate Exponentiation}

The last step of a Tate pairing computation is
to exponentiate some quantity $a$ by
\[ \frac{q^k-1}{r} = r^{-1} \prod_{d\mid k} \Phi_d(q) \]
Since $k$ is the embedding degree, we have $r \mid \Phi_k(q)$ (and no
cyclotomic polynomial of smaller degree).

Then $a^{(q^k-1)/r}$ may be computed as follows:
\begin{enumerate}
\item
Compute $b = a^d $ where
\[ d = \prod_{d\mid k, d<k} \Phi_d(q) , \]
exploiting the identity $x^q = x$ for all $x \in \Fq$.
\item
Since
\[ c = \frac{\Phi_k(q)}{r} \]
is an integer, compute the output $b^c$
using a standard exponentiation algorithm.
\end{enumerate}

We describe the steps in detail
for $k = 2$. Suppose $\F_{q^2}$ has been implemented
as $\Fq[\alpha]$. Typically $\alpha = i = \sqrt{-1}$.
Then $q^2 - 1 = \Phi_2(q)(q-1)$ and
$r \mid \Phi_2(q) = q + 1$. Write $a = u + \alpha v$ where $u,v \in \Fq$.
We have
\[ b = a^{q-1} = (u + \alpha v)^q a^{-1} = \frac{u + \alpha^q v}{a} .\]
The constant $\alpha^q$ can be precomputed. Usually $\alpha$ is a square root
of some quadratic nonresidue in $\Fq$, so $\alpha^q = -\alpha$ and
this step is essentially a single division.

Then compute $b^{(q+1)/r}$ using a standard exponentiation algorithm
to obtain $a^{(q^2-1)/r}$. We have effectively halved the size of the exponent.

Let us also work through the $k = 6$ case. Suppose we have $\F_{q^6}$
implemented as $\Fq[\alpha]$. Then
\[ q^6 - 1 = \Phi_6(q) (q^4 + q^3 - q - 1)\]
(where $\Phi_6(q) = q^2 - q + 1$).
If $a = u_0 + u_1 \alpha + ... + u^5 \alpha^5$ we have
\[ b =
a^{q^4 + q^3 - q - 1}
= \frac{
(u_0 + u_1 \alpha^{q^4} + ... + u_5 \alpha^{5q^4})
(u_0 + u_1 \alpha^{q^3} + ... + u_5 \alpha^{5q^3})}
{
(u_0 + u_1 \alpha^q + ... + u_5 \alpha^{5q})a
}
\]
where each power of $\alpha^q$ can be precomputed. Then exponentiate $b$
by $(q^2 - q + 1)/r$ using a standard algorithm.
In this case we have shrunk the exponent to roughly one third its original
size.

\section { Collating Inversions }

Recall the computation of a pairing involves several iterations
of multiplying by an expression of the form $g(Q) / h(Q)$
where $g, h$ are equations of lines and $Q$ is some point.

A straightforward optimization is to defer the division,
and have one inversion at the end instead of one per iteration, at
the cost of an extra variable.
In other words, compute $(g_1(Q) ... g_m(Q)) / (h_1(Q) ... h_m(Q)$ instead
of $(g_1(Q) / h_1(Q)) ... (g_m(Q) / h_m(Q)$.

\section {Precomputation of Lines}

In many pairing-based cryptosystems, a group element such as a system parameter
or a key that rarely changes is fed to the pairing over and over again in
typical use, behaviour that we can exploit with precomputation.

For example, in the BLS signature scheme, a system parameter and
signer's public key are given to the pairing during verification, thus
an application that verifies many BLS signatures from the same sender will be a
good candidate for this optimization.

Recall during a pairing computation, the coefficients in equations of the form
$aX + bY + c$ are calculated. These lines
are derived entirely from one of the input points,
hence much time can be saved every time the same input point is encountered
if we precompute and store $a, b, c$ for every line.

\section { Multipairings }

Because Miller's algorithm has features in common with an exponentation
routine, when computing products or quotients of pairings,

\section { Pairing Compression }

We quote results without proof from a paper
due to Scott and Barreto~\cite{compressedpairings}.

We first examine the simplest case.
Suppose we have constructed a pairing
with an elliptic curve $E$ over a field $\Fq$ with embedding degree 2,
so that the output of the pairing is an element of order $r$
in $\F_{q^2}$, where $r$ is the order of the cyclic subgroup being used.

Suppose $\F_{q^2}$ has been implemented as $\F_q[\alpha]$.
A typical choice is $\alpha = i (=\sqrt{-1})$.

From above, the last step of the optimized Tate exponentiation
consists of exponentiating a number of the form $a + \alpha b$ by
$(q + 1) / r$.

It can be shown $a + \alpha b$ must be \emph {unitary} (the proof
applies to any element of $\F_{q^2}$ whose order divides $q+1$), which
is to say $a^2 - \alpha^2 b^2 = 1$. This in turn implies
\emph{Lucas sequences} can be used to compute powers. Let $P = 2a$.

Define
\[ V_0 = 2, V_1 = P, V_{n+1} = P V_n - V_{n-1} . \]

It turns out that $(a+\alpha b)^n = V_n / 2 + \alpha b U$,
where $U = (P V_n - 2 V_{n-1}) / (P^2 - 4)
= (2 V_{n+1} - P V_n) / (P^2 - 4)$.

Consider the following \emph {laddering algorithm}.
Let $n_t ... n_0$ be the binary respresentation of $n$.

\begin{enumerate}
\item
$v_0 \leftarrow 2, v_1 \leftarrow P, j \leftarrow t$
\item
If $j = 0$ then
\begin{enumerate}
\item
$v_1 \leftarrow v_0 v_1 - P, v_0 \leftarrow v_0^2 - 2$
\item
Halt
\end{enumerate}
\item
If $n_j = 1$ then
\begin{enumerate}
\item
$v_0 \leftarrow v_0 v_1 - P, v_1 \leftarrow v_1^2 - 2$
\end{enumerate}
\item
Else
\begin{enumerate}
\item
$v_1 \leftarrow v_0 v_1 - P, v_0 \leftarrow v_0^2 - 2$
\end{enumerate}
\item
$j \leftarrow j - 1$
\item
Goto the step 2.
\end{enumerate}

It can be shown that upon termination, for even $n$ we have
$v_0 = V_n$ and $v_1 = V_{n+1}$, otherwise
$v_0 = V_{n-1}$ and $v_1 = V_n$, and we can easily compute $U$ in either
case.

Note we usually have $r$ odd (every pairing-based cryptosystem yet
proposed chooses
$r$ to be an odd prime or a product of two odd primes) and $q + 1$
even (we never work in characteristic 2 fields), so we
only encounter the case when $n = (q + 1) / r$ is even.

Clearly the above is faster than a standard $\F_{q^2}$ exponentiation
procedure as all operations take place in the smaller field $\Fq$.

This method applies to any curve of even embedding degree, but we shall
find that for embedding degree $k = 6$ an even better algorithm exists.
However, before describing it, we first discuss pairing compression.

Because the output of a pairing is some unitary element $a + \alpha b \in
\F_{q^2}$, for each value of $a$, there are two possibile values for $b$
since $a^2 - \alpha^2 b^2 = 1$.

Just as point compression works by recording only the $x$-coordinate and
one bit that signifies which $y$-coordinate to take, we may compress pairing
values by recording only the $a$ value and one bit that represents which
solutions of $a^2 - \alpha^2 b^2 = 1$ the $b$ takes.

To invert a group element on an elliptic curve is to negate the $y$-coordinate.
Similarly, we have $(a + \alpha b)^{-1} = a - \alpha b$ for pairing values.

Furthermore, yet another similarity is that in some applications it may
be possible to dispose of $b$ entirely and not bother recording which solution
to take.

The BLS signature scheme is a good example of when this is useful.

TODO: alternative Tate pairing computation method
TODO: ignoring last iteration
TODO: sliding windows, NAF (why NAF can be used)
TODO: char 3 optimizations
