\chapter{\label{chap:optimize}Faster Pairings}

We now focus on optimizing pairings.
Firstly, one can improve the running time of the rational function computation
by a factor of 2 by
applying a theorem due to Barreto, Kim, Lynn and Scott~\cite{bakls}.
This running time can be halved again by using a method
described by Barreto, Lynn and Scott~\cite{bals2}.

Barreto, Kim, Lynn and Scott~\cite{bakls}
also give techniques for speeding up the
final powering. The efficiency gain depends on the embedding degree,
but for $k=2$ curves we halve the running time and for $k=6$ the final
powering is three times as fast.
(Recall the output of the Tate pairing is a coset representative and we
need the final powering to standardize it.)

Because Miller's algorithm has features in common with an exponentation
routine, optimizations that improve powering routines can often be tailored to
improve pairings.

We mention other optimizations such as preprocessing and
pairing compression, though most of these techniques
either depend on certain properties of the cryptosystem,
or require it to be modified.

\section {\label{sec:quadratictwists}Twist Curves}

Let $E$ be an elliptic curve $Y^2 = X^3 + a X + b$ in $\Fq$ where
$q$ is a prime power.
Let $v$ be a quadratic nonresidue in $\Fq$.
Consider
the curve $E'$ given by $Y^2 = X^3 + a v^2 X + v^3 b$,
which we call the (quadratic) \emph{twist} of the curve $E$.

\begin{theorem}
Let $t = q + 1 - \#E(\Fq)$. Then $\#E'(\Fq) = q + 1 + t$.
\end{theorem}

The proof is straightforward.
Let $g(X) = X^3 + a X + b$, and $h(X) = X^3 + a v^2 X + v^3 b$.
Note $h(X) = v^3 g(Xv^{-1})$.

There are three cases.

\begin{enumerate}
\item
If $g(xv^{-1}) = 0$ then $v^3g(xv^{-1}) = h(x) = 0$ thus
$Y = 0$ is the unique solution to both the
equations $Y^2 = g(xv^{-1})$ and $Y^2 = h(x)$.
\item
If $g(xv^{-1})$ is a quadratic residue then $Y^2 = g(xv^{-1})$
has exactly two solutions,
and $Y^2 = v^3 g(xv^{-1}) = h(x)$ has no solutions (since $v^3$
is a quadratic nonresidue).
\item
If $g(xv^{-1})$ is a quadratic nonresidue then the situation is reversed:
$Y^2 = g(xv^{-1})$ has no solutions and
and $Y^2 = h(x)$ has exactly two solutions.
\end{enumerate}

As $x$ runs through all the elements of $\Fq$, so does $xv^{-1}$,
and we see that total number of solutions to either equation $E$ and $E'$
over $\Fq$ is $2q$.
Since $O$ is always a solution of any elliptic curve we have
$\#E(\Fq) + \#E(\Fq) = 2q + 2$, proving the theorem.

On the other hand if $v$ is a quadratic residue then $v = c^2$ for some
$c \in \Fq$. Then we have a map $\Psi : E'(\Fq) \rightarrow E(\Fq)$
given by
\[ \Psi(x,y) = (c^2 x,c^3 y) \]
hence in some sense $E$ and $E'$ are the same curve, so the choice of
quadratic nonresidue $v$ does not matter as they all lead to the same twist.

Note a quadratic
nonresidue $v$ becomes a quadratic residue in $\F_{q^2}$ (that is, we
can find a square root $c$ of $v$)
and we have a map between
$E'(\F_{q^2})$ and $E(\F_{q^2})$. Roughly speaking, curves that are twists
of each other become the same curve when considered in a quadratic extension
of the field within which they are defined.

For example, since $2$ is a quadratic nonresidue in $\F_{19}$,
the curve $E : Y^2 = X^3 + X + 6$ (over $\F_{19}$) has the
twist $E': Y^2 = X^3 + 4 X + 10$, and $E'(\F_{19})$ contains 22 points.

In $\F_{19^2}$, both $E$ and $E'$ contain 396 points, and we can map
points of $E'$ to points of $E$ via $(x,y) \mapsto (2 x, 2\sqrt{2} y)$.

We can use quadratic residues to transform the equation of a given elliptic
curve $E$ into a form that allows certain optimizations.
We would like $a = 0$ to reduce the amount of multiplications
needed for a projective point doubling, but for a general curve
this an impossible transformation. Recall from Section~\ref{sec:projcoord}
that a reasonable alternative is $a = -3$.

Then from above, a curve $Y^2 = X^3 + aX + b$ can be transformed into
one of the form $Y^2 = X^3 - 3X + b'$ if we can find $v\in \Fq$
satisfying $a v^2 = -3$.

When no such $c$ exists, a compromise is to have $a = 1$ or $a = -3 d^2$ for
some small integer $d$ (or $d$ of low Hamming weight), which can be achieved in
a similar manner, again to reduce the number of multiplications required by a
projective point doubling.

\section {Simplified Tate Pairing}

When the embedding degree is greater than $1$, we may simplify the Tate
pairing as follows~\cite{bakls, bals2}.

\begin{theorem}
Let $E$ be an elliptic curve over $\F_q$.
Let $P \in E(\F_q)$ be a point of prime order $r$.
Let $G = \langle P \rangle$, and let $k$ be the embedding degree of $G$.

If $k > 1$ then
\[
e(P,Q) = f_P(Q)^{(q^k-1)/r}
\]
is a bilinear nondegenerate map,
where $f_P$ is a function with divisor $r\langle P\rangle - r\langle O\rangle$.
\end{theorem}

\begin{proof}
Choose any point $R \in E(\F_q)$ that is not one of
$O, -P, Q, -Q, Q - P$,
and consider the function $f'_P$ that satisfies $(f'_P) = r\langle P+R\rangle
- r\langle R \rangle$.
The Tate pairing can be computed by
\[
(f'_P(Q)/f'_P(O))^{(q^k-1)/r}
\]
We have $f'(O) \in \F_q^*$ since it does not have a zero or pole
at $O$. Hence
$f'(O)^{(q^k-1)/r} = 1$ by Fermat's Little Theorem (we know $q-1$ must
divide $(q^k - 1)/r$ since $r\nmid q-1$) thus
\[ e(P,Q) = f'_P(Q)^{(q^k-1)/r} . \]
Let $V_R(X,Y)$ be the equation of a vertical line through $R$,
let $V_P(X,Y)$ be the equation of a vertical line through $P$,
and let $L(X,Y)$ be the equation of a line through $P+R$ and $-R$ (and hence
$-P$).
Then we have
\[ (f'_P V_R^r V_P^r / L^r) = r \langle P \rangle - r \langle O \rangle
= (f_P) \]
None of $V_R, V_P, L$ have zeroes or poles at $Q$ by choice of $R$.
Since each of $V_R(Q), V_P(Q), L(Q)$ is ultimately exponentiated by $q^k-1$
we have $f'_P(Q) = f_P(Q)$.
(Alternatively we could appeal to Fermat's Little Theorem
again, since the lines can be chosen to have coefficients in $\F_q$.)
Hence
\[e(P,Q) = f_P(Q)^{(q^k-1)/r} . \]
\end{proof}

\section {Simplified Weil Pairing}

We may also simplify the Weil pairing in a similar fashion.
Recall that two points $R, S$ are needed in addition to the input points
$P,Q$. We show that we can pick $R = O$ and compute the Weil pairing as
\[ f(P,Q) = \frac{f_P(Q+S)/f_P(S)}{f_Q(P)} \]
where $f_P$ is a rational function
satisfying $(f_P) = (P)^r$ (reminiscent of a rational function defined
for the Tate pairing),
and $f_Q$ is a certain rational function with divisor
$(f_Q) = (Q+S)^r /(S)^r$.

In our original definition, the choice of rational function for $f_Q$
did not matter. They are all equivalent up to a constant,
which cancels itself out during a division. In the above formula,
we never divide $f_Q$ by itself so we build $f_Q$ carefully as follows.

During Miller's algorithm each iteration consists of finding an equation of
a line and evaluting it at a certain point before multiplying it to the
running product. We compute $f_Q(P)$ in the same way, except we ensure
the lines, tangents and verticals have a particular form. For lines and
tangents, we pick the equation where the coefficient of $Y$ is unity.
For verticals, we pick the equation where the coefficient of $X$ is unity.

For this particular construction of $f_Q$, we can check that $f_Q(O) = 1$,
proving that we can indeed simplify the Weil pairing as claimed.

We can instead choose $S = O$ and compute
\[ f(P,Q) = \frac{f_P(Q)}{f_Q(P+R)/f_Q(R)} \]
with similarly defined $f_P, f_Q$.

Note we cannot simultaneously have $R = S = O$ for this would imply
both $f_P$ and $f_Q$ have poles at $O$ hence cannot be evaluated at $O$.

\section {\label{sec:twistcurves}Twist Curves and the Trace-Zero Group}

Let $E : y^2 = x^3 + a x + b$ be an elliptic curve over $\F_q$,
and $P$ be a point of prime order $r$.
Suppose the embedding degree $k$ of $G = \langle P \rangle$ is even.

Let $d = k / 2$. Let $v$ be a quadratic nonresidue in $\F_{q^d}$,
so that $\F_{q^k} = \F_{q^d}[\sqrt{v}]$.
Let $E'$ be the twist of $E$ hence
$E' : y^2 = x^3 + v^2 a x + v^3 b$.

Define the map $\Psi:E'\rightarrow E(\F_{q^k})$ by
\[ \Psi(x,y) = (v^{-1}x, v^{-3/2}y) . \]

\begin{theorem}
Let $E : y^2 = x^3 + a x + b$ be an elliptic curve over $\Fq$,
and $P$ be a point of prime order $r$.
Suppose the embedding degree $k$ of $G = \langle P \rangle$ is even.
Write $k = 2d$. Let $E'$ be the twist of $E$ in $\Fqd$.

Then $r \mid \#E'(\Fqd)$.
\end{theorem}

\begin{proof}
If $\#E(\F_{q^d}) = q^d + 1 - c$ then
\[ \#E'(\F_{q^d}) = q^d + 1 + c \]
and
\[ \#E(\F_{q^k}) = (q^{d} + 1 + c)(q^{d} + 1 - c) . \]
The group $E(\F_{q^d})$ only contains $r$ points of $E[r]$ otherwise
the embedding degree would be at most $d$, and similarly
$E(\Fqk)$ contains all $r^2$ points of $E[r]$,
hence
\[ r \mid q^{d} + 1 + c = \#E(\Fqd) .\]
\end{proof}

Let $P$ be any point of order $r$ in $E(\Fq)$ and
$Q'$ be any point whose order is a multiple of $r$ in $E'(\F_{q^d})$.
In practice a randomly chosen point of $E'(\F_{q^d})$ will do.

Let $G = \langle P \rangle, H = \langle Q' + r E'(\Fqd) \rangle$.
Note $H$ is a subgroup of $E'(\Fqd) / rE'(\Fqd)$.

Let $f$ be the Tate pairing.
Then $e$ defined by
\[e(P,Q') = f(P, \Psi(Q')) \]
is a bilinear map.
We may subsitute the Weil pairing if we ensure
$r Q' = O$ by suitable premultiplication.

In practical terms, this means most operations are performed in
$\F_{q^d}$  or $\F_q$. The $\Psi$ map and
other computations in $\Fqk$ are only performed
when a pairing is being evaluated.
Also note $G_2$ is cyclic, and that we can hash into $G_2$, features
useful to some cryptosystems.

We can view this trick as a
generalization of type A pairings.
Observe we have $k =2 , d = 1$, and
that the curve $E : y^2 = x^3 + x$ is equivalent to $E' : y^2 = x^3 + v^2 x$
because either $v$ or $-v$ is a quadratic residue, thus a type A curve is the
quadratic twist of itself. In this case, the pairing
is symmetric as well.

We can say more about this particular group selection.

\begin{theorem}
Let $E : y^2 = x^3 + a x + b$ be an elliptic curve over $\F_q$,
and $P$ be a point of prime order $r$.
Suppose the embedding degree $k$ of $G_1 = \langle P \rangle$ is even.
Then write $d = k / 2$. Let $v$ be a quadratic nonresidue in $\F_{q^d}$,
Let $E'$ be given by $y^2 = x^3 + v^2 a x + v^3 b$.
Define the map $\Psi:E'\rightarrow E(\F_{q^k})$ by
\[ \Psi(x,y) = (v^{-1}x, v^{-3/2}y) . \]

Then $G_2 = \Psi(E'(\F_{q^d})[r])$ is precisely the subgroup of trace zero points
in $E(\Fqk)[r]$.
\end{theorem}

\begin{proof}
Given $Q' = (X,Y) \in E'(\F_{q^d})$ we have $\Psi(Q') = (a, b)$
where $a \in \F_{q^d}$, and $b$ has the form $b = c \sqrt{v}$ for some
$c \in \F_{q^d}$.

Now $\Phi^d(\sqrt{v}) = -\sqrt{v}$, which
can be verified using
$v^{(q^d - 1)/2} = -1$ since $v$ is a quadratic nonresidue, or
with Galois theory: $\sqrt{v}$ must
be mapped to some other root of its minimal polynomial as $\Phi^d$ fixes
$\F_{q^d}$ but not $\F_{q^k}$.
Thus $\Phi^d(a) = a$ and $\Phi^d(b) = -b$, whence

\[ \Phi^d(\Psi(Q')) = \Phi^d(a,b) = (a, -b) = -\Psi(Q') \]

But it can be easily checked that
any point $Q \in E(\Fqk)$ satisfying $\Phi^d(Q) = -Q$ also satisfies
$\tr Q = O$, hence $\Psi(Q')$ is a point of trace zero.

Conversely, suppose $Q$ is a point of trace zero in $E(\Fqk)[r]$.
From Section~\ref{sec:eigenspace} we have $\Phi(Q) = q Q$,
thus $\Phi^d(Q) = q^d Q$.

Since $q^k = 1 \bmod r$, we have $q^d = -1 \bmod r$ (we cannot
have $q^d = 1 \bmod r$ since $k > d$ is the embedding degree).
Hence $\Phi^d(Q) = -Q$.

If we write $Q=(a,b)$ then this implies $a \in \F_{q^d}$ and $b = c \sqrt{v}$
for some $c \in \F_{q^d}$, thus $\Psi^{-1}(Q)$ lies on $E'(\F_{q^d})$.

Alternatively we may employ a counting argument to show the converse,
as there are exactly
$r$ points in $E'(\F_{q^d})[r]$ and exactly $r$ points in $E(\Fqk)[r]$ of trace
zero.
\end{proof}

One consequence is that, aside from type A pairings,
this group selection leads to an asymmetric bilinear pairing
\[
e:G_1 \times G_2 \rightarrow G_T
\]
with no known efficiently computable group isomorphism
$\phi : G_2 \rightarrow G_1$. Cryptosystems relying on the existence of
such a map must be modified accordingly if they are to use this trick.

Recall for a randomly chosen $Q$ in $E(\Fqk)[r]$ we have $\tr Q \ne O$ with
overwhelming probability, and one can take $\phi$ to be the trace map
as an efficiently computable isomorphism between $\langle Q \rangle$
and $E(\Fq)[r]$. However, as our second input is always a point of trace zero,
this choice of $\phi$ no longer applies,
thus we must use the more general definition
of a bilinear pairing.

\subsection {\label{sec:twistcurveremarks}Remarks on Implementation}

Observe that all cryptosystem operations except for the bilinear map
can be computed in $\Fq$ or $\F_{q^d}$.
One only needs to compute in $\Fqk$ for a pairing operation.

In particular,
when $k=2$ all cryptosystem operations except for the pairing
can be computed in $\Fq$.
More generally, for $k=2d$ where $d > 1$,
if $\Fqk$ is implemented as an extension of $\Fq$ using
a minimal polynomial consisting only of terms of even degree (that is as
sparse as possible),
then the elements of $\F_{q^d}$ are also polynomials containing only terms
of even degree.

We have in fact encountered this optimization before.
Given a Type A curve
\[E : y^2 = x^3 + x ,\]
its distortion map can be thought of as the
map $\phi$ above that takes points on the twist curve $E'(\Fq)$
to $E(\F_{q^2})$, since $E' = E$ in this case.

A dilemma arises with type B curves however:

\subsection {\label{sec:twistcurvetradeoffs}Twist Curve Trade-offs}

Recall a type B curve is given by
$E : y^2 = x^3 + 1$
over a field $\Fq$.
Its twist $E'$ is given by
$E' : y^2 = x^3 + v^3$
for some quadratic nonresidue $v$ and also over $\Fq$.
Elements of $G_1$ are points on $E(\Fq)$. We have two choices for
$G_2$:

\begin{enumerate}
\item
Take elements of $G_2$ from $E(\Fq)$, and
feed them into the distortion map $\Psi$ (Section~\ref{sec:typeb})
to obtain elements of $E(\F_{q^2})$ for the pairing.
Recall the distortion map is given by $\Psi(x,y) \mapsto (\zeta x , y)$
where $\zeta$ is a primitive cube root of unity.

Then we have symmetry as elements of either input group are chosen
from $E(\Fq)$.
Unfortunately, we cannot use the important optimization of the following
section.

\item
Use the twist curve, that is, take elements of $G_2$ from $E'(\Fq)$, and
feed them into the twist map $\phi$ to obtain elements of $E(\F_{q^2})$
for the pairing.

This allows us to eliminate denominators as described in the following
section, but also means we lose symmetry, since the points from $G_2$
lie in a different curve.
\end{enumerate}

More generally, for other curves, whether or not to use the twist curve
trick depends on if particular properties of the pairing are needed.

Some cryptosystems require DDH to be difficult in both input groups. In
such cases we must use the trace zero group for the second input group,
otherwise the trace map enables the pairing to break DDH in $G_2$.
Other schemes want DDH hard in $G_1$ only, but also a surjective map
from $G_2$ to $G_1$, in which case we cannot use the trace zero group.

Suppose $G_2$ must be cyclic in an asymmetric pairing.
Then if we want the ability to hash to $G_2$,
we must use the trace zero group, and thus cannot have an efficiently
computable isomorphism from $G_2$ to $G_1$.
Note we can hash to a point of trace zero
by first hashing to a point $Q \in E(\F_{q^2})$ and returning $\Phi(Q) - Q$.
Otherwise, if hashing is not needed for $G_2$, we may pick any point
$Q \in E(\F_{q^2})$ and use $G_2 = \langle Q \rangle$.

\section {\label{sec:denomelim}Denominator Elimination}

When using twist curves, we can halve the running time of a pairing by applying
a technique due to Barreto, Lynn and Scott~\cite{bals2}.
We use the same notation and assumptions as the previous section.
In other words, again let $E : y^2 = x^3 + a x + b$ be an elliptic curve
over $\F_q$,
and $P$ be a point of prime order $r$.
Suppose the embedding degree $k$ of $G = \langle P \rangle$ is even
and write $k = 2d$.

The Tate pairing requires us to find $f_P(Q)$.
In Miller's algorithm, calculating the denominator of
$f_P(Q)$ involves evaluating the equation of various vertical lines
at a point. In other words, we compute $x - a$ where $a$ is the
$x$-coordinate of the line and $x$ is the $x$-coordinate of $Q$.

Recall we eventually exponentiate the output of Miller's algorithm by
$(q^k - 1)/r$ to standardize the coset representative. Observe
$q^d - 1$ divides $(q^k-1)/r$ because if $r$ divides $q^d - 1$ then
the embedding degree is at most $d$, not $k$.

Thus if both $x$ and $a$ lie in $\F_{q^d}$ then we have
$(x-a)^{q^d - 1} = 1$ so they can be omitted during Miller's algorithm.
This occurs when twist curves are used, hence we may simplify
the computation of $f_P(Q)$ as follows. Recall that $T_Z$ denotes the
equation of the tangent at $Z$ and $L_Z$ denotes the equation of
the line between $Z$ and $P$.

\begin{algorithm}
\caption {Miller's Algorithm with Denominator Elimination: $f \gets f_P(Q)$}
\begin{algorithmic}[1]
\STATE Let the binary representation of $r$ be $b_t ... b_0$.
\STATE $f \gets 1$
\STATE $Z \gets P$
\FOR {$i\gets t-1$ to $0$}
    \STATE $f \gets f^2 \cdot T_Z(Q)$
    \STATE $Z \gets 2Z$
    \IF {$b_i = 1$}
	\STATE $f \gets f \cdot L_Z(Q)$
	\STATE $Z \gets Z + P$
    \ENDIF
\ENDFOR
\end{algorithmic}
\end{algorithm}

Assuming $r$ is odd, which holds for all practical applications,
the if condition is true during the last iteration and
the last multiplication is
\[ f \leftarrow f L_{(r-1)P}(Q) .\]
Since $(r-1)P = -P$, this is equivalent to $f \leftarrow f V_P(Q)$
and hence can be skipped since no vertical line computations are needed.
In other words, we have $f_r = f_{r-1}$ and the logic can be simplified.

\section {\label{sec:inputrestriction}Input Restriction}

We have already covered most of the facts of this section, but we wish
to emphasize that, from an efficiency standpoint, choosing the input
groups to be certain subgroups is desirable for all pairings.

Consider a supersingular type A, B or C curve $E$ over $\Fq$ containing
a cyclic group of order $r$ of embedding degree $k$. Recall
a distortion map $\phi$ exists for this curve.
Let $f$ be the Weil or Tate pairing for this
curve.
We can instantiate the symmetric pairings of Section~\ref{sec:symmetricpairing}
(i.e. the input groups are the same, cyclic and lie over smaller fields)
by defining $G = E(\Fq)[r]$,
$G_T$ to be the group of $r$th roots of unity in $\Fqk$.
and $e : G \times G \rightarrow G_T$ by
$e(P,Q) = e(P, \phi(Q))$.

More generally let $E(\Fq)$ be an elliptic curve containing a cyclic
group of order $r$ of embedding degree $k$.
Distortion maps might not exist for our curve $E$.
However, we can always restrict the first input to $E(\Fq)[r]$,
which is cyclic when $k > 1$,
and we have just seen that for even $k = 2d$,
the other input can be restricted to some curve over $\F_{q^d}$.

This is faster to compute in than $\F_{q^k}$ and allows denominator
elimination. Moreover, the second input group is now cyclic and we can hash
into it. The only potential drawback is that there is no known efficient method
for mapping elements of one input group to the other, which could complicate
security proofs or even render the pairing unsuitable for certain
cryptosystems.

For certain pairings, the higher degree twists of Section~\ref{sec:hightwists}
can be used for greater savings.

\section {Miller-Lite Operations}

Let $P$ be the first input to a pairing. During Miller's algorithm, we compute
multiples of $P$ and equations of lines that pass through multiples of $P$.
Thus if we restrict $P \in E(\Fq)[r]$ then all the arithmetic involved for
these operations, which form the bulk of Miller's algorithm, can be performed
in $\Fq$ rather than $\Fqk$.

This has been dubbed a \emph{Miller-Lite} operation in the literature.
When $P$ does not lie in the base field but rather is some element of
$E(\Fqk)$ then we refer to an iteration of Miller's algorithm
as a \emph{full Miller} or \emph{Miller-Full} operation.

\section{Last-Second Conversions}

One easy optimization is also easy to overlook as it is hidden by notation. In
a Miller-Lite operation, at some point we must encounter $\Fqk$ arithmetic.
Distortion maps or twist maps must be applied on the second input point $Q$ to
obtain a point on $E(\Fqk)$, which in turn is fed to line equations.

However this should be done carefully. We wish to avoid computing in $\Fqk$
until absolutely necessary. We describe the procedure in detail for type A
pairings. Similar statements can be made for other pairing types.

Let $e : E(\mathbb{F}_q) \times E(\mathbb{F}_q)
\rightarrow \mathbb{F}_{q^2}$ be a type A pairing 
and suppose we have chosen to
use $\mathbb{F}_q [i]$ to represent $\mathbb{F}_{q^2}$ where $i =\sqrt{-1}$.

During the computation of the pairing,
we evaluate $g(Q')$ where $g = aX + bY + c$ is an equation of some line and
$Q' = \phi(Q)$, where $\phi$ is defined by  $(X,Y) \mapsto (-X, iY)$
and $Q$ is some point $(x,y)$ in $E(\mathbb{F}_q)$.

If we follow the notation blindly, we would first compute the point
$Q'$ which takes twice as much storage as $Q$ (as the field it lies over is
twice as big), and perform operations on elements of $\mathbb{F}_q[i]$ to
arrive at $g(Q')$.

It is wiser to never explicitly compute $Q'$ and instead do
\[ Re(R) \gets c - a x , Im(R) \gets b y .\]
Now $R = g(Q')$, and we have only computed in $\mathbb{F}_q$.

\section {The Final Powering}

The last step of a Tate pairing computation is
to exponentiate some quantity $a$ by
\[ \frac{q^k-1}{r} = r^{-1} \prod_{d\mid k} \Phi_d(q) \]
Since $k$ is the embedding degree, we have $r \mid \Phi_k(q)$ (and no
cyclotomic polynomial of smaller degree).

The following method for computing $a^{(q^k-1)/r}$ is faster
than the obvious approach~\cite{bakls}.
\begin{enumerate}
\item
Compute $b = a^d $ where
\[ d = \prod_{d\mid k, d<k} \Phi_d(q) , \]
exploiting the identity $x^q = x$ for all $x \in \Fq$.
\item
Since
\[ c = \frac{\Phi_k(q)}{r} \]
is an integer, compute the output $b^c$
using a standard exponentiation algorithm.
\end{enumerate}

We describe the steps in detail
for $k = 2$. Suppose $\F_{q^2}$ has been implemented
as $\Fq[\alpha]$. Typically $\alpha = i = \sqrt{-1}$.
Then $q^2 - 1 = \Phi_2(q)(q-1)$ and
$r \mid \Phi_2(q) = q + 1$. Write $a = u + \alpha v$ where $u,v \in \Fq$.
We have
\[ b = a^{q-1} = (u + \alpha v)^q a^{-1} = \frac{u + \alpha^q v}{a} .\]
The constant $\alpha^q$ can be precomputed. Usually $\alpha$ is a square root
of some quadratic nonresidue in $\Fq$, so $\alpha^q = -\alpha$ and
this step is essentially a single division.

Then compute $b^{(q+1)/r}$ using a standard exponentiation algorithm
to obtain $a^{(q^2-1)/r}$. We have effectively halved the size of the exponent.

Let us also work through the $k = 6$ case. Suppose we have $\F_{q^6}$
implemented as $\Fq[\alpha]$. Then
\[ q^6 - 1 = \Phi_6(q) (q^4 + q^3 - q - 1)\]
(where $\Phi_6(q) = q^2 - q + 1$).
If $a = u_0 + u_1 \alpha + ... + u_5 \alpha^5$ we have
\[ b =
a^{q^4 + q^3 - q - 1}
= \frac{
(u_0 + u_1 \alpha^{q^4} + ... + u_5 \alpha^{5q^4})
(u_0 + u_1 \alpha^{q^3} + ... + u_5 \alpha^{5q^3})}
{
(u_0 + u_1 \alpha^q + ... + u_5 \alpha^{5q})a
}
\]
through liberal use of the identity $(x + y)^q = x^q + y^q \bmod q$.
Again, each power of $\alpha^q$ can be precomputed.
Exponentiate $b$
by $(q^2 - q + 1)/r$ using a standard algorithm to produce the final answer.
In this case we have shrunk the exponent to roughly one third its original
size.

The $k=12$ case (which occurs for the type F pairing) is similar.
We need to compute $a^{(q^{12}-1)/r}$ for some $a \in \F_{q^{12}}$
for some prime $q$ and group order $r$.
This is best done by computing $b=a^{q^8 +q^6 -q^2 -1}$ followed by
exponentiating $b$ by $\Phi_{12}(q)/r = (q^4 - q^2 + 1)/r$.

Suppose $k$ is even but not divisible by four.
Let $k = 2 d$ where $d$ is odd. Suppose
$\Fqd$ has been implemented as $\Fq[\alpha]$, and $\Fqk$ as
$\Fqd[\beta] = \Fq[\alpha, \beta]$.
where $\beta$ is some quadratic nonresidue in $\Fq$.

Then every element $a\in \Fqk$ can be written in the form
\[ a = (u_0 + v_0 \beta)
+ (u_1 + v_1 \beta) \alpha
+ ... + (u_{d-1} + v_{d-1} \beta) \alpha^{d-1} \]

Note $\beta^q = -\beta$.
Thus for even $m$ we have
\[ a^{q^{d + m}} = (u_0 - v_0 \beta)
+ (u_1 - v_1 \beta) \alpha^q
+ ... + (u_{d-1} - v_{d-1} \beta) \alpha^{q^{m-1}} \]
and for odd $m$ we have
\[ a^{q^{d + m}} = (u_0 + v_0 \beta)
+ (u_1 + v_1 \beta) \alpha^q
+ ... + (u_{d-1} + v_{d-1} \beta) \alpha^{q^{m-1}} \]
allowing the following simplifications.

When $k=6$ then any $a \in \Fqk$ can be written in the form
\[ a = (u_0 + v_0 \beta)
+ (u_1 + v_1 \beta) \alpha
+ (u_2 + v_2 \beta) \alpha^2 . \]
Then $b = a^{q^4 + q^3 - q - 1}$
can be computed via
\[
\frac
{
\left(
(u_0 + v_0 \beta)
+ (u_1 + v_1 \beta) \alpha^q
+ (u_2 + v_2 \beta) \alpha^{2q}
\right)
\left(
(u_0 - v_0 \beta)
+ (u_1 - v_1 \beta) \alpha
+ (u_2 - v_2 \beta) \alpha^2
\right)
}
{
\left(
(u_0 - v_0 \beta)
+ (u_1 - v_1 \beta) \alpha^q
+ (u_2 - v_2 \beta) \alpha^{2q}
\right)
\left(
(u_0 + v_0 \beta)
+ (u_1 + v_1 \beta) \alpha
+ (u_2 + v_2 \beta) \alpha^2
\right)
}
\]

The right-hand factor of the denominator is simply $a$ and the right-hand
factor of the numerator is its conjugate.

A similar formula applies when $k=10$ (type G pairings).
In this case we compute $b = a^{q^6 + q^5 - q - 1}$, before
exponentiating by $\Phi_5(q) / r = (q^4 - q^3 + q^2 - q + 1)/r$.

\section {Weil Denominator Elimination}

Let $f$ be a Weil pairing
\[ f:E[r] \times E[r] \rightarrow \Fqk \]
for some curve $E$ over $\Fq$ with embedding degree $k > 1$, and for some
$r$.

For pairing-based cryptography, any nondegenerate bilinear map can be used.
Thus we may replace $f$ by $f^n$ where $n$ is prime to $r$.
The map $f^n$ is still nondegenerate and bilinear; it merely differs from the
Weil pairing by a constant factor.

In particular, if we choose $n = q - 1$ then denominator elimination
also applies to the Weil pairing. Additionally, the above powering trick
makes the exponentiation cheap.

\section {Preprocessing}

We previously discussed preprocessing for exponentiation in a group.
In general opportunities for calculating and storing
certain results ahead of time frequently arise.

One trivial application of this principle
is generating and storing random points and number needed for certain pairing
computations long before they are needed, reusing them when possible.
Another is the caching of quadratic nonresidues that are key
ingredients in a number of algorithms.

In many pairing-based cryptosystems, a group element such as a system parameter
or a key that rarely changes is fed to the pairing over and over again in
typical use, behaviour that we can exploit with precomputation.

For example, in the BLS signature scheme, a system parameter and
signer's public key are given to the pairing during verification, thus
an application that verifies many BLS signatures from the same sender will be a
good candidate for this optimization.

\subsection {Precomputation of Lines}

During Miller's algorithm, the coefficients in equations of the form
$aX + bY + c$ are calculated. These lines
are derived entirely from one of the input points,
hence much time can be saved every time the same input point is encountered
if we precompute and store $a, b, c$ for every line~\cite{bakls}.

\subsection {Elliptic Net Precomputation}

One of the two sequences in the Shipsey-Stange algorithm, which
we denoted by $c_k$ is completely determined by the first input.
Thus caching $c_k^2$ and $c_{k-1}c_{k+1}$ for later pairings
will improve the running time substantially.

\section {\label{sec:compressedpairings}Compressed Pairings}

In the next few sections we quote without proof observations
due to Scott and Barreto~\cite{compressedpairings} that speed up pairings and
reduce their output size, though in some cases at the cost of losing a few bits.

We first examine the simplest case. Suppose we have constructed a pairing
with an elliptic curve $E$ over a field $\Fq$ with embedding degree 2,
so that the output of the pairing is an element of order $r$
in $\F_{q^2}$, where $r$ is the order of the cyclic subgroup being used.

Suppose $\F_{q^2}$ has been implemented as $\F_q[\alpha]$.
A typical choice is $\alpha = i (=\sqrt{-1})$.

From above, the last step of the optimized Tate exponentiation
consists of exponentiating a number of the form $a + \alpha b$ by
$(q + 1) / r$.

It can be shown $a + \alpha b$ must be \emph {unitary} (the proof
applies to any element of $\F_{q^2}$ whose order divides $q+1$), which
is to say $a^2 - \alpha^2 b^2 = 1$. This in turn implies
\emph{Lucas sequences} can be used to compute powers. Let $P = 2a$.

Define
\[ V_0 = 2, V_1 = P, V_{n+1} = P V_n - V_{n-1} . \]

It turns out that $(a+\alpha b)^n = V_n / 2 + \alpha b U$,
where $U = (P V_n - 2 V_{n-1}) / (P^2 - 4)
= (2 V_{n+1} - P V_n) / (P^2 - 4)$,
and that the following algorithm
computes $v_0 = V_n$ and $v_1 = V_{n+1}$ for even $n$,
and $v_0 = V_{n-1}$ and $v_1 = V_n$ otherwise.
We can easily compute $U$ in either case.

\begin{algorithm}
\caption {Lucas sequence: $v_0 = V_m$ and $v_1 = V_{m+1}$,
where $m = n$ for even $n$ and $m = n-1$ for odd $n$}
\begin{algorithmic}[1]
\STATE Let $n_t ... n_0$ be the binary respresentation of $n$.
\STATE $v_0 \gets 2, v_1 \gets P, j \gets t$
\WHILE {$j > 0$}
    \IF {$n_j = 1$}
	\STATE $v_0 \gets v_0 v_1 - P, v_1 \gets v_1^2 - 2$
    \ELSE
	\STATE $v_1 \gets v_0 v_1 - P, v_0 \gets v_0^2 - 2$
    \ENDIF
    \STATE $j \gets j - 1$
\ENDWHILE
\STATE $v_1 \gets v_0 v_1 - P, v_0 \gets v_0^2 - 2$
\end{algorithmic}
\end{algorithm}

Every pairing-based cryptosystem yet
proposed requires $r$ to be an odd prime or a product of two odd primes,
thus we assume $r$ is odd. As we avoid characteristic 2 fields,
we also assume $q + 1$ is even, so we
can assume $n = (q + 1) / r$ is even.

Clearly the above is faster than a standard $\F_{q^2}$ exponentiation
procedure as all operations take place in the smaller field $\Fq$.
This method applies to any curve of even embedding degree.

\section {\label{sec:pairingcompressioneven}Pairing Compression For Even Embedding Degree}

We have seen that the output of a pairing is some unitary element
$a + \alpha b \in \F_{q^2}$.
Hence for each value of $a$, there are two possibile values for $b$
since $a^2 - \alpha^2 b^2 = 1$.

Just as point compression works by recording only the $x$-coordinate and
one bit that signifies which $y$-coordinate to take, we may compress pairing
values by recording only the $a$ value and one bit that represents which
solutions of $a^2 - \alpha^2 b^2 = 1$ the $b$ takes.

To invert a group element on an elliptic curve is to negate the $y$-coordinate.
Similarly, we have $(a + \alpha b)^{-1} = a - \alpha b$ for pairing values.

Furthermore, in some applications it may be possible to dispose of $b$ entirely
and not bother recording which solution to take. This is similar to the point
reduction described earlier, and in fact, these two tricks work well in unison.

The BLS signature scheme is a good example of this.
Recall a signature is an $x$-coordinate of some point $P$ and we need to
check if $e(P, Q)$ is a certain pairing value $v$,
where $Q$ is a system parameter.
Since we have discarded the $y$-coordinate, when guessing a value for $P$
we may have in fact selected $-P$, in which case we will have computed
$e(-P, Q)$ instead, and previously we recommended checking the other possible
$y$-coordinate in event of a mismatch.

But observe that $e(P,Q)$ and $e(-P,Q)$ will have the same $a$-value,
and are the only pairing values that share this $a$-value.
This suggests the following BLS signature verification procedure:

\begin{enumerate}
\item
Given a signature $\sigma$, compute any point $P$ with $x$-coordinate $\sigma$.
\item
Compute the $a$-value of $e(P,Q)$, where $Q$ is the system parameter.
Do not bother with the $b$-value.
\item
If this value matches the $a$-value of $v$ then the signature verifies.
Otherwise it is rejected.
\end{enumerate}

\section {Pairing Compression For Embedding Degree Six}

Now consider a curve $E(\Fq)$ with embedding degree $k=6$.
Recall from the discussion of Tate exponentiation that
$r \mid \Phi_6(q) = q^2 - q + 1$ (and $r$ does not divide any
smaller cyclotomic polynomial).

These are precisely the conditions that occur in the XTR
cryptosystem~\cite{xtr}, the optimizations and algorithms of which we quote
here.

Let $\tr$ denote the $\F_{q^2}$-trace in $\F_{q^6}$,
that is
\[ \tr(x) = x + x^{q^2} + x^{q^4}  \in \F_{q^2} .\]
Let $x \in \F_{q^6}$ be an element of order $r$ (such as the output of
a pairing).
Define $c_k = \tr(x^k)$.
It can be shown that
\[ c_{u+v} = c_u c_v - c_v^q c_{u-v} + c_{u-2v} \]
for all $u,v\in\mathbb{Z}$,
which leads to the identities:
\[ c_{n+2} = c_1 c_{n+1} - c_1^q c_n + c_{n-1} \]
\[ c_{2n} = c_n^2 - 2c_n^q \]
\[ c_{2n-1} = c_n c_{n-1} - c_1 c_n^q + c_{n+1}^q \]
\[ c_{2n+1} = c_n c_{n+1} - c_1 c_n^q + c_{n-1}^q \]

Then for any integer $n$, we can use a repeated-squaring-like algorithm to
compute $\tr(x^n)$ from $\tr(x)$.

One can show $\tr (x^n) = (\tr(x^{-n}))^q$ so without loss of generality assume
$n \ge 0$. Trivially $c_0 = 3, c_1 = \tr(x)$ and $c_2, c_3, c_4$ can be
computed easily using the above identities, e.g. $c_2 = c_1^2 - 2c_1^q$.
Otherwise:

\begin{enumerate}
\item
If $n$ is odd let $2m + 1 = n$, otherwise
let $2m = n$, and let the binary representation of
$m$ is $m_t ... m_0$.
\item
$k \leftarrow 1$.
\item
For $j \leftarrow t-1$ to $0$ do
\begin{enumerate}
\item
If $m_j = 0$ then
compute $c_{4k}, c_{4k+1}, c_{4k+2}$ from $c_{2k}, c_{2k+1}, c_{2k+2}$,
using the above identities.
\item
Otherwise $m_j = 1$ and
compute $c_{4k+2}, c_{4k+3}, c_{4k+4}$ from $c_{2k}, c_{2k+1}, c_{2k+2}$,
using the above identities.
\item
$k \leftarrow 2 k + m_j$
\end{enumerate}
\item
We have now computed $c_{2m}, c_{2m+1}, c_{2m+2}$. (If $n$ is odd
$c_n = c_{2m+1}$ otherwise $c_n = c_{2m}$.)
\end{enumerate}

Thus we can compress the output $x$ of a pairing by a factor of three by
using $\tr(x)$ instead of $x$, and the above shows how to find
$\tr(x^n)$ for any integer $n$,
a feature often required by pairing-based cryptosystems.
(In general $\tr(x)^n \ne \tr(x^n)$ so we cannot use a standard
exponentiation algorithm.)
Of course, in doing so we lose some information: $x, x^{q^2}, x^{q^4}$
all have the same trace, but this is tolerable in most cases.

Recall from Section~\ref{sec:quadext} that
if $q = 2 \pmod 3$ or $q = 3 \pmod 4$, then with a suitable constructed
field extension $\F_{q^2}$, for $x, y, z \in \F_{q^2}$:
\begin{enumerate}
\item
computing $x^q$ is free
\item
computing $x^2$ costs 2 multiplications in $\Fq$
\item
computing $x y$ costs 3 multiplications in $\Fq$
\item
computing $x z - y z^q$ costs 4 multiplications in $\Fq$
\end{enumerate}
where we assume the time taken by a few
additions and subtractions is negligible.

Since these are the operations aside from addition and
subtraction involved in the above identities,
exponentiating compressed pairings is
significantly faster for carefully constructed field extensions.

\section {Powered Pairings}

Michael Scott notes that in many cryptosystems the result of a pairing is
raised to some power at some stage. In some cases the output of a pairing
is not used until after it has been exponentiated.
Thus when designing a pairing library, one should make
a powered pairing function available to the user, to take full advantage
of the above optimizations that allow faster exponentiation of pairing outputs.

Also, for any $m$ coprime to the group order $r$, the $m$th power of a pairing
is a nondegenerate bilinear map. Thus in any cryptosystem we can replace
the pairing with the $m$th power of the pairing.

One application of this is to replace a Weil pairing $e$ of even embedding
degree $k = 2d$ in any cryptosystem with $e^{q^d-1}$, which means
denominator elimination can be applied
during the computation of the Weil pairing. Recall raising to the $q$th
power is a cheap operation, so this will speed up the Weil pairing~\cite{km}.

In fact, this optimization makes it less clear which pairing
is faster. The Tate pairing costs one Miller-Lite operation and a final
powering. The powered Weil pairing costs one Miller-Lite
and one Miller-Full operation, and needs no final powering.
In both cases, denominator elimination applies. Without
final powering optimizations, a Miller-Full might outperform it,
in which case the Weil pairing would beat the Tate pairing~\cite{gps}.

\section {Exponentiation Tricks}

Miller's algorithm has features in common with exponentation by repeated
squaring. Accordingly, tricks that speed up the latter can be adapted for the
former.

Let us analyze the analogue of division in Miller's algorithm.
Using the notation of Chapter 3, we have
\[
(f_{-k}) = (P)^{-k}/(-kP)
\]
hence
\[
f_{-k}(Q) = \frac{1}{f_k(Q)V_k(Q)}
\]
and
\[
f_{a-b}(Q) = \frac{f_a(Q)L_{a,-b}(Q)}{f_b(Q)V_b(Q)V_{a-b}(Q)}
\]

Since group inversion, i.e. point negation, is practically free,
we may neglect the cost of computing $-kP$ from $kP$. We may treat
the cost of computing $(a-b)P$ from $aP$ and $bP$ as the same as the
cost of computing $(a+b)P$.

We see a division in Miller's algorithm is slightly more expensive than
a multiplication, requiring also an inversion in $G_T$ along with
another vertical line.

Denominator elimination allows us to ignore vertical lines. Also, the
inversions can be collated. We can defer divisions, and have one inversion at
the end instead of one per iteration, by maintaining numerator and denominator
variables during the main loop and only dividing at the end. (In other words,
compute $(g_1(Q) ... g_m(Q)) / (h_1(Q) ... h_m(Q))$ instead of $(g_1(Q) /
h_1(Q)) ... (g_m(Q) / h_m(Q))$.)

Thus addition-subtraction-chain exponentiation can be
better than plain addition-chain exponentiation and as with
point multiplication, one can employ signed sliding
windows~\cite[Chapter 14]{handbook}~\cite[Section IV.2.5]{bss}.

As mentioned before the last iteration of Miller's algorithm can be skipped
if denomination elimination is applied.
This is also true for the signed representation, because
\[
f_{r+1} = f_r L_{rP} / V_{r+1}P
\]
but since $rP = O$
we have that $L_{rP}$ is a vertical line at $P$ and hence $f_{r+1} = f_r$
(recall we ignore verticals for denominator elimination).

Sometimes it is possible to choose the order $r$ of the input and output
groups. In such cases it is desirable to pick $r$ so that the resulting
addition-subtraction-chain is as short as possible. For example, a good choice
is an $r$ that has the form $2^a \pm 2^b \pm 1$ (Solinas numbers) or has low
Hamming weight~\cite{bakls}.

Like multiexponentiation, when computing products or quotients of pairings we
benefit from using vector addition chains~\cite[Chapter 14]{handbook}, with
much time saved by using a precomputed table.

Although we recommend avoiding characteristic 3 curves, we note some special
optimizations for them~\cite{bakls}. Firstly, point tripling is extremely fast.
Given a point $(x,y)$ we can quickly compute $(x_3,y_3) = 3(x,y)$ via
\[
\begin{array}{lcl}
x_3 &=& (x^3)^3 - b \\
y_3 &=& -(y^3)^3
\end{array}
\]
since cubing is cheap in characteristic 3
(here $b$ is the constant term of the elliptic curve).
Then if we use signed ternary representation point multiplication can be
sped up. Furthermore, if $r$ is chosen to
a base 3 analogue of a Solinas number $3^a \pm 3^b \pm 1$,
then Miller's algorithm is much faster.

\section {\label{sec:hightwists}Higher Degree Twists}

We quote facts neatly summarized by
Hess, Smart and Vercauteren~\cite{hsv}.

Let $E$ be an elliptic curve over $\Fq$ where $q\ge 5$ is prime.
Let $t$ be the trace of Frobenius, that is,
$t$ satisfies $\#E(\Fq) = q-t+1$.
Table~\ref{tbl:twistcurves}
describes the twists of $E$
for various choices of $v \in \F_q^*$.
Some choices of $v$ result in
the original curve (or rather a curve easily mapped to the original),
while others lead to quadratic, cubic, quartic or sextic twists, which are
depicted in the table.
We define $w$, the degree of the twist,
as the smallest integer such that the twist curve
maps to $E(\F_{q^w})$ by taking a point $(x,y)$ to the point shown in the table.
We must have $q = 1 \bmod w$ for a twist of degree $w$ to exist.

\begin{table}
\begin{center}
\begin{tabular}{|l|c|l|c|c|}

  \hline
  Curve & $w$ & Twist & Twist Map & Point Count \\
  \hline
  $Y^2 = X^3 + a X + b$ & 2 &
  $Y^2 = X^3 + a / v^2 X + b / v^3$ &
  $v x, v^{3/2} y$ &
  $q + 1 + t$ \\
  \hline
  $Y^2 = X^3 + a X$ & 2 &
  $Y^2 = X^3 + a / v X$ &
  $v^{1/2} x, v^{3/4} y$ &
  $q + 1 + t$ \\
  & 4 & & & $q + 1 \pm f$ \\
  & & & & ($t^2 - 4q = -f^2$) \\
  \hline
  $Y^2 = X^3 + b$ & 2 &
  $Y^2 = X^3 + b / v$ &
  $v^{1/3} x, v^{1/2} y$ &
  $q + 1 + t$ \\
  & 3 & & & $q + 1 - (\pm 3f - t)/2$ \\
  & 6 & & & $q + 1 - (\pm 3f + t)/2$ \\
  & & & & ($t^2 - 4q = - 3f^2$) \\
  \hline
\end{tabular}
\end{center}
\caption{\label{tbl:twistcurves}
    Twist curves
}
\end{table}

A simple method to find a desired twist is to

\begin{enumerate}
\item Choose $v \in \F_q^{*}$ and construct the twist $E'$ using $v$.
\item Generate a random point $P \in E'$.
\item If $P$ does not have the order specified by Table~\ref{tbl:twistcurves}
then goto step 1.
\end{enumerate}

The twist curve optimization tricks discussed earlier correspond to
quadratic twists.
For this case, Hess, Smart and Vercauteren note the alternate form:
\[ E : v Y^2 = X^3 + a X + b \]
with
\[ \phi : (x,y) \mapsto (x, v^{1/2} y) \]
may be better from a programmer's point of view.

We can generalize our method to higher-degree twists
on certain curves (and embedding degrees), leading to greater time and space
savings.

Let $G$ be a cyclic subgroup of $E(\Fq)$ of prime order $r \ge 5$
and embedding degree $k$.
In all cases, it can be shown exactly one of the twist curves
has order that is a multiple of $r$. Let $w$ be the degree of this twist.

We assume that $w$ divides $k$. When this is not the case,
we can use a suitable factor of $w$ instead with reduced savings.
In the extreme case, we have $E' = E$ and $d = k$ which implies we
are not using the twist curve optimization at all and gain nothing.
Let $d = k/w$. Then as before, we can work within the groups $E(\Fq)[r]$
and $E'(\Fqd)$ for a suitable twist curve $E'$ at all times except
during a pairing computation, where we use the twist map and
operate in $\Fqk$.

\section {The Ate and Twisted Ate Pairing}

Barreto et al. discovered a variation on the Tate pairing,
dubbed the Eta pairing, that can be more efficient in some cases~\cite{etapairing}.
Hess, Smart and Vercauteren further refine this new pairing and obtain
the Ate pairing~\cite{hsv}. We state their results without proof.

Let $E$ be an elliptic over $\Fq$ containing a cyclic subgroup $G_1$ of
order $r$ and even embedding degree $k$. Let $G_2$ be the group of trace zero
points in $E'(\Fqd)$ where, like the previous section,
$E'$ and $d$ represent the twist curve optimization
being employed. Let $t$ be the trace of Frobenius, that
is $t$ satisfies $\#E(\Fq) = q-t+1$.

Let $f_{n,P}$ be a rational function with divisor $n(P)/(nP)$ for any integer
$n$ and any point $P$. Then the following are bilinear and nondegenerate
up to coset representatives (in practice one needs to execute a final powering
on the output of any of these functions).
\begin{enumerate}
\item
Tate pairing:
\[ f_{r,P}(Q) \]
\item
Ate pairing:
\[ f_{t-1,Q}(P) \]
\item
Twisted Ate pairing:
\[ f_{(t-1)^d,P}(Q) \]
\end{enumerate}

In some cases, the Ate or twisted Ate pairing may be faster than the Tate
pairing. Note that even when $t-1$ is much smaller than $r$,
the Ate pairing may not necessarily be faster because it
requires a Miller-Full operation.
